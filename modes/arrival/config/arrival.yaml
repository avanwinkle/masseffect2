#config_version=5

#####
# ARRIVAL MULTIBALL MODE
#
# The arrival multiball is available during field play after the Collector Ship
# mission has been played. Hitting either of the Batarian hitbank targets will
# light lock up to three balls (for Escaping Med Bay, Activating Cooling Rods,
# and Powering Engines). On the third ball lock, a four-ball multiball begins.
#
# The basic run of the multiball lights 3 lanes on a timer. Hitting a shot or
# a timer runout disables the lit lanes and enables the other two (and the
# timer restarts). The pattern continues where each hit/timeout swaps the
# lit and unlit lanes, but hit lanes get "locked". When all five lanes are
# locked, they all reset and the pattern repeats.
#
# At the same time, a frenzy is active and every switch hit brings the player
# closer to the mass relay. When the hit count is complete, the lane shot
# pattern stops and a ball hold opens in the kickback lane. For each ball the
# player locks, they receive the full jackpot value accumulated from the lane
# shots.
#
# If the player drains to one ball during the lane shots, the ball hold phase
# activates immediately. After all the balls are either held or drained, the
# mode ends with the player escaping (at least one ball held) or failing to
# escape (no balls held).
#####

mode:
  start_events: start_mode_arrival
  stop_events: stop_mode_arrival, stop_wizards
  events_when_started: mode_type_wizard_started, fmball_started, start_mode_frenzy
  events_when_stopped: mode_type_wizard_stopped, fmball_stopped, stop_mode_frenzy
  priority: 1000

event_player:
  mode_arrival_started:
    - enable_arrival_orbits
  reset_arrival:
    - enable_arrival_orbits
  timer_arrival_timer_complete:
    - enable_arrival_orbits{device.counters.arrival_orbits_counter.value<3 and current_player.temp_multiplier==1}
    - enable_arrival_ramps{device.counters.arrival_ramps_counter.value<2 and current_player.temp_multiplier==0}
  multiball_arrival_multiball_ended:
    # If the multiball ended before the hold is enabled, enable it
    - enable_arrival_hold{not device.ball_holds.arrival_hold.enabled}
  # If a ball drains and all the rest are in the hold, that's the end of the mode
  ball_drain{game.balls_in_play==device.ball_holds.arrival_hold.held_balls}:
    - stop_mode_arrival
  logicblock_arrival_frenzy_counter_complete: enable_arrival_hold
  # When one counter is hit, switch to the other (if it has shots to hit)
  logicblock_arrival_orbits_counter_hit{not device.counters.arrival_ramps_counter.completed}:
    - enable_arrival_ramps
  logicblock_arrival_ramps_counter_hit{not device.counters.arrival_orbits_counter.completed}:
    - enable_arrival_orbits
  # Reset if both counters are complete
  logicblock_arrival_orbits_counter_complete{device.counters.arrival_ramps_counter.completed}:
    - reset_arrival
  logicblock_arrival_ramps_counter_complete{device.counters.arrival_orbits_counter.completed}:
    - reset_arrival
  # Stop frenzy when hold is enabled
  enable_arrival_hold: stop_mode_frenzy
  # Sound player won't do conditions
  logicblock_arrival_frenzy_counter_updated:
    - play_arrival_engine_25{value==60}
    - play_arrival_engine_50{value==120}
    - play_arrival_engine_75{value==180}
    - play_arrival_engine_100{value==240}
    - play_arrival_collision_imminent{value==255}
    - play_arrival_get_to_escape_shuttles{value==299}

multiballs:
  arrival_multiball:
    ball_count: 4
    ball_count_type: total
    ball_locks: bd_lock
    shoot_again: 12s
    start_events: mode_arrival_started

variable_player:
  # Temp multiplier: 0 == orbits, 1 == ramps
  mode_arrival_started:
    temp_multiplier:
      action: set
      int: 0
    temp_build_value:
      action: set
      int: machine.base_points
  enable_arrival_orbits:
    temp_multiplier:
      action: set
      int: 0
  enable_arrival_ramps:
    temp_multiplier:
      action: set
      int: 1
  logicblock_arrival_ramps_counter_hit:
    temp_build_value: machine.base_points / 10 * (device.counters.arrival_ramps_counter.value + device.counters.arrival_orbits_counter.value)
  logicblock_arrival_orbits_counter_hit:
    temp_build_value: machine.base_points / 10 * (device.counters.arrival_ramps_counter.value + device.counters.arrival_orbits_counter.value)
  ball_hold_arrival_hold_held_ball:
    score: current_player.temp_build_value

timers:
  arrival_timer:
    start_value: 20
    end_value: 0
    direction: down
    tick_interval: current_player.research_tick_interval_perk * (1.2 if current_player.difficulty==0 else 1)
    restart_on_complete: true
    start_running: true
    control_events:
      - event: enable_arrival_hold
        action: stop

counters:
  # Count how many shots in each are hit, to avoid toggling to no shots
  arrival_ramps_counter:
    starting_count: 0
    direction: up
    count_events: arrival_ramps_lit_hit
    count_complete_value: 2
    # In theory, counter should reset + disable on complete
    enable_events: mode_arrival_started, reset_arrival
  arrival_orbits_counter:
    starting_count: 0
    direction: up
    count_events: arrival_orbits_lit_hit
    count_complete_value: 3
    enable_events: mode_arrival_started, reset_arrival
  arrival_frenzy_counter:
    starting_count: 0
    count_events: frenzy_hit
    # We can't math the value for the widget, but it's 300px wide
    count_complete_value: 300
    count_interval: 3

shot_groups:
  arrival_ramps:
    shots: arrival_left_ramp, arrival_right_ramp
    enable_events: enable_arrival_ramps
    disable_events: enable_arrival_orbits, enable_arrival_hold
    reset_events: reset_arrival
  arrival_orbits:
    shots: arrival_left_orbit, arrival_right_orbit, arrival_kickback
    enable_events: enable_arrival_orbits
    disable_events: enable_arrival_ramps, enable_arrival_hold
    reset_events: reset_arrival

shots:
  arrival_hold_shot:
    enable_events: enable_arrival_hold
    profile: color_flashing_profile
    show_tokens:
      leds: light_lock_lit
      color: color_arrival
  arrival_left_ramp:
    hit_events: sh_left_ramp_hit
    disable_events: arrival_left_ramp_hit
    profile: lane_shot_profile
    show_tokens:
      leds: l_left_ramp_ring
      color: color_arrival
    tags: envshot_left_ramp, power_target, power_target_left_ramp
  arrival_left_orbit:
    hit_events: sh_left_orbit_hit
    disable_events: arrival_left_orbit_hit
    profile: lane_shot_profile
    show_tokens:
      leds: l_left_orbit_ring
      color: color_arrival
    tags: envshot_left_orbit, power_target, power_target_left_orbit
  arrival_right_ramp:
    hit_events: sh_right_ramp_hit
    disable_events: arrival_right_ramp_hit
    profile: lane_shot_profile
    show_tokens:
      leds: l_right_ramp_ring
      color: color_arrival
    tags: envshot_right_ramp, power_target, power_target_right_ramp
  arrival_right_orbit:
    hit_events: sh_right_orbit_hit
    disable_events: arrival_right_orbit_hit
    profile: lane_shot_profile
    show_tokens:
      leds: l_right_orbit_ring
      color: color_arrival
    tags: envshot_right_orbit, power_target, power_target_right_orbit
  arrival_kickback:
    hit_events: sh_kickback_hit
    disable_events: arrival_kickback_hit
    profile: lane_shot_profile
    show_tokens:
      leds: l_kickback_ring
      color: color_arrival
    tags: envshot_kickback, power_target, power_target_kickback

slide_player:
  mode_arrival_started:
    arrival_slide:
      action: play
    arrival_portrait_1:
      target: lcd_right
  enable_arrival_hold:
    arrival_escape_slide:
      action: play
    arrival_portrait_4:
      target: lcd_right

slides:
  arrival_slide:
    widgets:
      - type: text
        text: ARRIVAL
        style: header_xs, row_top, col_left_anchor, color_ui_green_light
      - type: text
        text: (player|temp_build_value)
        style: header_lg, row_main, col_left_anchor, num
      - type: text
        text: Jackpot Value
        style: body_xs, row_sub, col_left_anchor
        casing: uppercase
      - widget: background_console
  arrival_escape_slide:
    widgets:
      - type: text
        text: ARRIVAL
        style: header_xs, row_top, col_left_anchor, color_ui_green_light
      - type: text
        text: Escape!
        style: header_md, row_main, col_left_anchor, num
      - type: text
        text: Lock balls for Jackpot
        style: body_sm, row_sub, col_left_anchor
      - widget: background_console
  arrival_portrait_1:
    widgets:
      - type: image
        image: portrait_arrival_phase_1
  arrival_portrait_4:
    widgets:
      - type: image
        image: portrait_arrival_phase_4

widget_player:
  slide_arrival_slide_created:
    arrival_frenzy_progress_widget:
      action: add
      slide: arrival_slide
  logicblock_arrival_frenzy_counter_complete:
    arrival_frenzy_progress_widget:
      action: remove
      slide: arrival_slide

widgets:
  arrival_frenzy_progress_widget:
    - type: text
      text: Alpha Relay Proximity
      style: header_xs, row_bottom, col_right_anchor, color_ui_yellow
      animations:
        add_to_slide: pulse_text_slow
    - type: line
      points: 389, 17, 389, 35, 691, 35, 691, 17, 389, 17
      thickness: 1
      color: fbc795  # color_ui_orange
      z: 101
    - type: rectangle
      width: 1
      height: 16
      anchor_x: left
      anchor_y: bottom
      x: 390
      y: 18
      z: 100
      color: "AA0000"  # color_door_red
      animations:
        logicblock_arrival_frenzy_counter_updated:
          - property: width
            value: (value)
    - type: rectangle
      width: 300
      height: 16
      anchor_x: left
      anchor_y: bottom
      x: 390
      y: 18
      z: 99
      color: FFFFFF
      opacity: 0.1

sound_player:
  mode_arrival_started: arrival_music
  play_arrival_phase1_1: arr_ken_i_can_still_override_engines
  play_arrival_engine_25: arr_annc_engine_at_25pct
  play_arrival_engine_50: arr_annc_engine_at_50pct
  play_arrival_engine_75: arr_annc_engine_at_75pct
  play_arrival_engine_100: arr_annc_engine_at_100pct
  play_arrival_collision_imminent: arr_annc_warning_collision_imminent
  play_arrival_get_to_escape_shuttles: arr_annc_get_to_escape_shuttles
  logicblock_arrival_frenzy_counter_completed: arr_shep_joker_i_need_a_pickup
  ball_hold_arrival_hold_held_ball{balls_held==1}: arr_normandy_inbound

sounds:
  arrival_music:
    file: ARR.09.Escaping_The_Station.ogg
    track: music
    fade_in: 2s
    fade_out: 1s
    start_at: 45s
    mode_end_action: stop
    markers:
      - time: 53s
        events: start_arrival_phase1
      - time: 65s
        events: start_arrival_phase2
      - time: 92s
        events: start_arrival_phase3
      - time: 120s
        events: start_arrival_phase4
      - time: 132s
        events: start_arrival_phase5
      - time: 147s
        events: start_arrival_finale
  arr_annc_engine_at_25pct:
    file: DLC_EXP_Part02_Int.026.ogg
    track: voice
  arr_annc_engine_at_50pct:
    file: DLC_EXP_Part02_Int.027.ogg
    track: voice
  arr_annc_engine_at_75pct:
    file: DLC_EXP_Part02_Int.028.ogg
    track: voice
  arr_annc_engine_at_100pct:
    file: DLC_EXP_Part02_Int.029.ogg
    track: voice
  arr_annc_get_to_escape_shuttles:
    file: DLC_EXP_Part02_Int.620.ogg
    track: voice
  arr_annc_warning_collision_imminent:
    file: DLC_EXP_Part02_Int.623.ogg
    track: voice
  arr_shep_joker_i_need_a_pickup:
    file: DLC_EXP_Part02_Int.627.ogg
    track: voice
  arr_shep_joker_do_you_read:
    file: DLC_EXP_Part02_Int.727.ogg
    track: voice
  arr_ken_i_can_still_override_engines:
    file: DLC_EXP_Part02_Int.589.ogg
    track: voice
  arr_normandy_inbound:
    file: DLC_EXP_Part02_Int.729.ogg
    track: voice
  arr_harb_prepare_yourself:
    file: DLC_EXP_Part02_Int.716.ogg
    track: voice
