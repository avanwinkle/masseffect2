#config_version=5
mode:
  start_events: ball_starting
  stop_events: ball_will_end
  priority: 100

config:
  - base_achievements.yaml
  - base_debug.yaml
  - base_endsounds.yaml
  - base_medigel.yaml
  - base_shows.yaml
  - base_scoring_timer.yaml

event_player:
  mode_base_started:
    - start_mode_suicide_base{device.achievements.suicidemission.state=="started"}
    - start_mode_skillshot{device.achievements.suicidemission.state!="started"}
    - start_mode_global{device.achievements.suicidemission.state!="started"}
    - start_mode_lockhandler
    - start_mode_environment
    - start_mode_firewalker
    - enable_orbitswitches
    - enable_kickback
    - right_flipper_on
    - left_flipper_on
    - reset_missionselect_bypass

  # If we are starting a new game, give some instructional audio
  # If we are starting a game and have recruited, different sounds
  #### DISABLE for faster playtesting
  mode_base_started.3{current_player.squadmates_count==2 and current_player.resume_mission==" " and device.achievements.suicidemission.state!="started"}:
    - play_intro_show
  mode_base_started.4{current_player.squadmates_count>2 and device.achievements.suicidemission.state!="started"}:
    - play_gameintro_recruits_long{current_player.ball==1}
    - play_gameintro_recruits_short{current_player.ball==3}

  mode_base_will_stop:
    - stop_mode_global
    - stop_mode_lockhandler
    - stop_mode_environment
    - stop_wizards
    - flippers_off
  mode_type_wizard_started:
    - stop_mode_global
  mode_type_wizard_stopped{not mode.base.stopping}:
    - start_mode_global
  # If a new mission becomes available, remove the player-selected bypass
  player_available_missions{player_num==current_player.number and change>0}:
    - reset_missionselect_bypass
  # When we have 6 squadmates (aka 4 recruits completed), go to collector ship
  player_squadmates_count{player_num==current_player.number and value==6}:
    - enable_collectorship
  missionselect_collectorship_selected:
    - start_mode_collectorship_base
  # When we have reached level 8, go to derelict reaper. This can be from
  # completing 7 recruits, or fewer recruits plus other mission levelups. It's
  # important to track how many levels are possible to avoid enabling derelict
  # reaper _before_ collectorship. Since collectorship requires 4 recruits and
  # derelict reaper requires 7 levelups, only three levelups should be allowed
  # before collectorship: Overlord, Shadowbroker Vasir, and Shadowbroker Boss
  player_level{player_num==current_player.number}:
    - enable_derelictreaper{value==8}
    # Every three levels warrants a ship upgrade!
    - shipupgrade_available{value%3==0 and device.achievement_groups.shipupgrades_group.enabled}
    - reset_missionselect_bypass
  missionselect_derelictreaper_selected:
    - start_mode_derelictreaper
  missionselect_suicide_selected:
    - start_mode_suicide_base
  fullorbit_enter_hit:
    - enable_gates
    - disable_orbitswitches
    - disable_gates|900ms
    # TODO: Replace these delay events with a timer that can reset on every entrance event
    - enable_orbitswitches|1200ms  # Tried 900 but got false positives on longwalk, increasing to 1100 (min +40)
                                   # Tried 1100 but came up 2ms shy on Kasumi, increasing to 1200
  # From an auto-plunger launch, open the gates and disable the switches
  # TODO: don't open the gates during multiball, to keep left orbit open for shots
  fullorbit_fromplunger_hit:
    - enable_gates
    - disable_orbitswitches
    - disable_gates|1500ms
    - enable_orbitswitches|2000ms
  # From a plunger launch, disable orbit switches to avoid cheat-easy hits
  s_plunger_lane_inactive:
    - disable_orbitswitches
    - enable_orbitswitches|2000ms
  # From a plunger orbit launch, re-enable orbit switches once left orbit is hit
  fullorbit_complete_hit:
    - enable_orbitswitches|200ms
  # Mission resume events need to be here because base is how we enable the shot
  player_shot_missionresume_shot_enabled{value==False}:
    - disable_missionresume
  flipper_cradle:
    - start_mode_instantinfo
  flipper_cradle_release:
    - stop_mode_instantinfo
  # Defer the awarding of points to avoid a blip in the slide.
  # Do this in base so starting missionselect won't miss it
  recruit_advance: defer_recruit_advance_score|1s
  levelup:
    queue_slide:
      slide: levelup_slide
      mission_name:
        value: mission_name
      portrait:
        value: portrait
        type: string
      priority: 1999 # Normandy attack runs at 2000

ball_saves:
  default:
    active_time: 20s
    grace_period: 2s
    hurry_up_time: 5s
    enable_events:
      - mode_base_started
    timer_start_events:
      - balldevice_bd_plunger_ball_eject_success
    disable_events:
      - ball_will_end
      - ball_save_recruitsave_enabled # Only allow one active save at a time
      - start_mode_normandyattack # We want the ball to drain when the attack starts
      - start_mode_suicide_base # Suicide mission plays by its own rules
    auto_launch: true
    balls_to_save: 1
    early_ball_save_events: s_outlane_left_active, s_outlane_right_active

extra_balls:
  recruits_extraball:
    award_events: player_recruited_squadmates_count{player_num==current_player.number and value==3}
  omegarelay_extraball:
    award_events: omegarelay_shots_hit_complete

counters:
  # Vasir and Hagalaz are wizard modes, so global_shadowbroker misses their complete events
  sbdrops_counter:
    count_events:
      - drop_target_bank_dropbank_down
      # Mode global_shadowbroker will advance the counter after vasir
      - manual_sbdrops_counter_advance
    starting_count: current_player.counter_sbdrops_counter
    count_complete_value: 7
    persist_state: true
    disable_on_complete: false
    reset_on_complete: false
    enable_events:
      # Count is enabled if vasir and hagalaz are not enabled/stopped AND boss is disabled
      - enable_sbdrops_counter{device.achievements.chase.state!="enabled" and device.achievements.chase.state!="stopped" and device.achievements.vasir.state!="enabled" and device.achievements.vasir.state!="stopped" and device.achievements.hagalaz.state!="enabled" and device.achievements.hagalaz.state!="stopped" and device.achievements.shadowbroker.state=="disabled"}
    disable_events:
      - disable_sbdrops_counter
      - achievement_chase_state_enabled
      - achievement_vasir_state_enabled
      - achievement_hagalaz_state_enabled
      - achievement_shadowbroker_state_enabled

light_player:
  mode_base_started:
    light_backwall_gi:
      color: 9999AA
    light_backwall_ambient:
      color: 0044AA

variable_player:
  defer_recruit_advance_score:
    score: 500
  levelup:
    level: 1
    earned_level: 1
    # Reset the ship upgrade every levelup. Once missed, gone forever!
    shipupgrade_available:
      action: set
      int: 0
  # Use a variable to know whether a ship upgrade is available
  shipupgrade_available:
    available_shipupgrades: 1
  # Track the squadmates recruited _this game_, not ones imported from saves
  player_squadmates_count{player_num==current_player and change==1}:
    earned_squadmates_count: 1
  # Use achievements to track available missions
  achievement_collectorship_state_enabled:
    available_missions: 1
  achievement_collectorship_state_started:
    available_missions: -1
  achievement_derelictreaper_state_enabled:
    available_missions: 1
  achievement_derelictreaper_state_started:
    available_missions: -1
  suicide_progression_omegarelay:
    available_missions: 1
  reset_missionselect_bypass:
    bypass_missionselect:
      action: set
      int: 0
  # For save careers, how many balls has the player played in total?
  mode_base_started:
    balls_played: 1
    intro_played: 0
  play_intro_show:
    intro_played: 1

shots:
  # These "core" shots for the main shots
  # This way, the mode-specific shots can always be enabled and show shows, but
  # they won't trigger hits unless the underlying core shot is enabled. This allows
  # us to use global methods of disabling core shots, e.g. ball save and full orbit,
  # without having to duplicate the logic in modes or re-sync mode shot shows.
  sh_left_ramp:
    switch: s_left_ramp_exit
  sh_left_orbit:
    switch: s_left_orbit
    enable_events: enable_orbitswitches, enable_leftorbit
    disable_events: disable_orbitswitches
  sh_right_ramp:
    switch: s_right_ramp_exit
  sh_right_orbit:
    switch: s_right_orbit
    enable_events: enable_orbitswitches, enable_rightorbit
    disable_events: disable_orbitswitches
  sh_spinner:
    switch: s_spinner
    enable_events: enable_orbitswitches
    disable_events: disable_orbitswitches
  sh_kickback:
    switch: s_kickback
  sh_hitbank_top:
    switch: s_hitbank_top
  sh_hitbank_bottom:
    switch: s_hitbank_bottom
  sh_dropbank_top:
    switch: s_dropbank_top
  sh_dropbank_middle:
    switch: s_dropbank_middle
  sh_dropbank_bottom:
    switch: s_dropbank_bottom
  # Other commonly-used or commonly-behaving shots
  fullorbit_enter:
    switches: s_left_orbit, s_right_orbit
    enable_events: enable_fullorbit
    disable_events: disable_fullorbit
  fullorbit_fromplunger:
    hit_events: balldevice_bd_plunger_ejecting_ball
    enable_events: enable_fullorbit
    disable_events: disable_fullorbit
  # Re-enable orbit switches IMMEDIATELY if the ball moves from plunger to
  # left orbit, i.e. completes an orbit. It could be hit up to right orbit very
  # quickly, faster than the normal orbit timeout
  fullorbit_complete:
    switch: s_left_orbit
    enable_events: fullorbit_fromplunger_hit
    disable_events: enable_orbitswitches
  # Allow the player to start mission select before the ball is launched
  missionresume_shot:
    hit_events: s_action_button_active, flipper_cancel
    enable_events: mode_base_started
    disable_events: s_plunger_lane_inactive, mode_type_mission_started

sequence_shots:
  left_to_right_orbit:
    switch_sequence: s_spinner, s_left_orbit, s_right_orbit
    sequence_timeout: 800ms # How long to finish the orbit?
                            # How fast to fall down left orbit and get shot up?

show_player:
  ball_save_default_enabled:
    ball_save_preshow:
      action: play
  ball_save_default_timer_start:
    ball_save_preshow:
      action: stop
    ball_save_show:
      action: play
      speed: 3
      priority: 10
  ball_save_default_hurry_up:
    ball_save_show:
      action: play
      speed: 9
  ball_save_default_grace_period:
    ball_save_show:
      action: stop
  ball_save_default_disabled:
    ball_save_preshow:
      action: stop
    ball_save_show:
      action: stop
  logicblock_omegarelay_extraball_counter_complete:
    flash:
      key: extraball_lit_show
      show_tokens:
        leds: l_kickback_arrow_amber
  extra_ball_awarded:
    extraball_lit_show:
      action: stop
    on:
      key: extraball_awarded_show
      show_tokens:
        leds: l_ball_save
  mode_suicide_omegarelay_stopped:
    extraball_lit_show:
      action: stop
  player_extra_balls{player_num==current_player.number and value==0}:
    extraball_lit_show:
      action: stop
  play_intro_show:
    introshow_missions:
      loops: 0


shows:
  ball_save_preshow:
    - lights:
        l_ball_save: on
  ball_save_show:
    - time: 0
      lights:
        l_ball_save:
          color: black
    - time: '+1'
      lights:
        l_ball_save:
          color: white
  flash_all_shields_show:
    - time: 0
      lights:
        l_left_orbit_shield_rgb: (color)
        l_left_ramp_shield_rgb: (color)
        l_kickback_shield_rgb: (color)
        l_right_ramp_shield_rgb: (color)
        l_right_orbit_shield_rgb: (color)
        l_dropbank_shield_rgb: (color)
        l_hitbank_shield_rgb: (color)
    - time: '+1'
      lights:
        l_left_orbit_shield_rgb: black
        l_left_ramp_shield_rgb: black
        l_kickback_shield_rgb: black
        l_right_ramp_shield_rgb: black
        l_right_orbit_shield_rgb: black
        l_dropbank_shield_rgb: black
        l_hitbank_shield_rgb: black
        l_null: (color)
    - time: '+1'
  flash_color_show:
    - time: 0
      lights:
        (leds): (color)
    - time: '+1'
      lights:
        (leds): black
        l_null: (color)
  flasher_show_single:
    - duration: 200ms
      flashers:
        (flashers): 120ms
    - duration: 10s
  flasher_show_double:
    - duration: 200ms
      flashers:
        (flashers): 120ms
    - duration: 200ms
      flashers:
        (flashers): 120ms
    - duration: 10s
  flasher_show_triple:
    - duration: 200ms
      flashers:
        (flashers): 120ms
    - duration: 200ms
      flashers:
        (flashers): 120ms
    - duration: 200ms
      flashers:
        (flashers): 120ms
    - duration: 10s
  color_on:
    - lights:
        (leds): (color)
  color_off:
    - lights:
        (leds): black
        l_null: (color)
  introshow_missions:
    - time: 0
      events:
        queue_slide{current_player.available_missions>0}:
          slide: intro_missions_slide
          transition_type: none
          portrait: squad
          expire: 8s
        queue_slide{current_player.available_missions==0}:
          slide: intro_no_missions_slide
          transition_type: none
          portrait: squad
          expire: 8s
    - time: 1
      events:
        - play_gameintro_norecruits_long_four{current_player.ball==1 and current_player.casual}
        - play_gameintro_norecruits_long_five{current_player.ball==1 and not current_player.casual}
        - play_gameintro_norecruits_short{current_player.ball==3}

slide_player:
  n7_assignment_shot_hit:
    n7_complete_slide:
      priority: 600
      expire: 3s
  skillshot_lit_hit:
    skillshot_slide:
      # Higher priority than the instructions slide (at 200) and planets (610+300)
      priority: 920
      expire: 3s
  mode_base_started{machine.has_secondscreen}:
    squadicon_slide:
      action: play
      target: lcd_right
      priority: 100

slides:
  levelup_slide:
    widgets:
      - type: text
        text: LEVEL UP!
        style: header_lg row_main row_main_dmd_high
      - type: text
        text: (mission_name)
        style: body_md row_sub_under
        casing: title
      - widget: levelup_background
  n7_complete_slide:
    widgets:
      - type: text
        text: $assignment_complete
        style: header_md row_main
  skillshot_slide:
    - type: text
      text: SKILLSHOT
      style: header_lg row_main row_main_dmd_high
    - type: text
      text: (temp_build_value)
      style: body_md row_sub_under num
  squadicon_slide:
    - type: image
      image: squadmates_grid
      z: 10
    - type: rectangle
      color: 000000
      width: 500
      height: 500
      z: 0
    # SQUADMATES
    - type: rectangle
      key: sqicon_garrus
      width: 121
      height: 158
      anchor_x: left
      anchor_y: bottom
      animations:
        show_slide: sqicon_available
      x: 0
      y: 0
      z: 2
    - type: rectangle
      key: sqicon_grunt
      width: 121
      height: 158
      anchor_x: left
      anchor_y: bottom
      animations:
        show_slide: sqicon_available
      x: 121
      y: 0
      z: 2
    - type: rectangle
      key: sqicon_jack
      width: 121
      height: 158
      anchor_x: left
      anchor_y: bottom
      animations:
        show_slide: sqicon_available
      x: 242
      y: 0
      z: 2
    - type: rectangle
      key: sqicon_jacob
      width: 121
      height: 158
      anchor_y: bottom
      anchor_x: left
      animations:
        show_slide: sqicon_available
      x: 363
      y: 0
      z: 2
    - type: rectangle
      key: sqicon_kasumi
      width: 121
      height: 158
      anchor_y: bottom
      anchor_x: left
      animations:
        show_slide: sqicon_available
      # animations:
      #   show_slide: sqicon_available
      x: 0
      y: 158
      z: 2
    - type: rectangle
      key: sqicon_legion
      width: 121
      height: 158
      anchor_y: bottom
      anchor_x: left
      animations:
        show_slide: sqicon_available
      x: 121
      y: 158
      z: 2
    - type: rectangle
      key: sqicon_miranda
      width: 121
      height: 158
      anchor_y: bottom
      anchor_x: left
      animations:
        show_slide: sqicon_available
      x: 242
      y: 158
      z: 2
    - type: rectangle
      key: sqicon_mordin
      width: 121
      height: 158
      anchor_y: bottom
      anchor_x: left
      animations:
        show_slide: sqicon_available
      x: 363
      y: 158
      z: 2
    - type: rectangle
      key: sqicon_samara
      width: 121
      height: 158
      anchor_y: bottom
      anchor_x: left
      animations:
        show_slide: sqicon_available
      x: 0
      y: 316
      z: 2
    - type: rectangle
      key: sqicon_tali
      width: 121
      height: 158
      anchor_y: bottom
      anchor_x: left
      animations:
        show_slide: sqicon_available
      x: 121
      y: 316
      z: 2
    - type: rectangle
      key: sqicon_thane
      width: 121
      height: 158
      anchor_y: bottom
      anchor_x: left
      animations:
        show_slide: sqicon_available
      x: 242
      y: 316
      z: 2
    - type: rectangle
      key: sqicon_zaeed
      width: 121
      height: 158
      anchor_y: bottom
      anchor_x: left
      animations:
        show_slide: sqicon_available
      x: 363
      y: 316
      z: 2
    - type: image
      image: squadmates_grid_overlay
      z: 100
  intro_no_missions_slide:
    - type: text
      text: Build Your Team
      style: header_md, row_main, row_main_dmd_high
    - type: text
      text: "Hit any lane 3x\nto unlock missions"
      style: header_xs, row_sub_under
    - widget: background_console
  intro_missions_slide:
    - type: text
      text: Build Your Team
      style: header_md, row_main, row_main_dmd_high
    - type: text
      text: "Select a mission\nat the Galaxy Map"
      style: header_xs, row_sub_under
    - widget: background_console


sound_player:
  s_plunger_lane_inactive: galaxy_whoosh
  play_gameintro_norecruits_long_four: illusive_already_compiled_dossiers_four
  play_gameintro_norecruits_long_five: illusive_already_compiled_dossiers_five
  play_gameintro_norecruits_short: gameintro_norecruits_short
  play_gameintro_recruits_long: gameintro_recruits_long
  play_gameintro_recruits_short: gameintro_recruits_short
  levelup:
    music_mission_success:
      action: play
      priority: 2 # Field music is 1, so this trumps only that
  # Whether starting a mission or game over, kill the "levelup" music if field stops
  mode_field_will_stop:
    music_mission_success:
      action: stop
      fade_out: 1s
  skillshot_lit_hit: skillshot_sound

sound_pools:
  gameintro_norecruits_short:
    track: voice
    type: sequence
    sounds:
      - shep_ill_need_a_really_good_team
      - illusive_find_mordin
  gameintro_recruits_long:
    track: voice
    type: random_force_all
    sounds:
      - illusive_more_dossiers
      - miranda_more_recruiting_options
      - shepard_more_people_we_have_the_better
  gameintro_recruits_short:
    track: voice
    type: random_force_all
    sounds:
      - illusive_youll_get_who_you_need
      - illusive_your_team_will_need_to_be_strong

sounds:
  galaxy_whoosh:
    file: sfxgame.Wwise_Generic_Galaxy_Map.gui_galaxy_whoosh_long.ogg
    track: sfx
  music_mission_success:
    file: mus_gui_mission_completion.ogg
    track: levelup # Use a special track to avoid music fadeout conflicts
    loop: 0
    fade_in: 500ms
    fade_out: 10s
    ducking:
      target: music
      delay: 1500ms
      attack: 1s
      attenuation: 0
      release_point: 18s
      release: 4s
  illusive_already_compiled_dossiers_four:
    file: en_us_global_illusive_man_profre_illusive_d_00332317_m.ogg
    track: voice
    volume: 0.9
  illusive_already_compiled_dossiers_five:
    file: en_us_global_illusive_man_profre_illusive_d_00332318_m.ogg
    track: voice
    volume: 0.9
  illusive_find_mordin:
    file: en_us_global_illusive_man_profre_illusive_d_00324686_m.ogg
    track: voice
  shep_ill_need_a_really_good_team:
    file: en_us_player_f_profre_illusive_d_00252123_f.ogg
    track: voice
  illusive_more_dossiers:
    file: en_us_global_illusive_man_norcr1_debriefing_d_00320983_m.ogg
    track: voice
  miranda_more_recruiting_options:
    file: en_us_hench_vixen_norcr3_denoument2_d_00294616_m.ogg
    track: voice
  shepard_more_people_we_have_the_better:
    file: en_us_player_f_norcr2_team_meeting_d_00310670_f.ogg
    track: voice
  illusive_youll_get_who_you_need:
    file: en_us_global_illusive_man_profre_illusive_d_00252066_m.ogg
    track: voice
  illusive_your_team_will_need_to_be_strong:
    file: en_us_global_illusive_man_norcr1_debriefing_d_00320977_m.ogg
    track: voice
  chambers_the_illusive_man_wishes_to_speak_with_you:
    file: en_us_nor_yeoman_nor_yeoman_a_00275675_m.ogg
    track: voice
  chambers_edi_ready_to_install_iff:
    file: en_us_nor_yeoman_nor_yeoman_a_00295517_m.ogg
    track: voice
  joker_change_of_plans_patching_illusive_man_through:
    file: en_us_hench_joker_nor_galaxy_map_a_00275671_m.ogg
    track: voice

track_player:
  # Bring the music out asap to allow for the bonus music to fade in
  ball_will_end:
    music:
      action: stop_all_sounds
      fade: 500ms
    field_music_track:
      action: stop_all_sounds
      fade: 500ms
  # In case a mode has audio that wants to queue-block on ball_ending
  ball_ending:
    __all__:
      action: stop_all_sounds
      fade: 500ms

