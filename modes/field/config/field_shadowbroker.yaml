#config_version=5

#####
# LAIR OF THE SHADOW BROKER: FIELD MODE
#
# This mode contains the show elements related to Shadow Broker progression that
# display during Field mode.
#####

event_player:
  # Shadow Broker modes are only triggered from Field
  drop_target_bank_dropbank_down:
    # Complete the dropbank after chase+vasir is enabled to begin the chase
    - start_mode_shadowbroker_chase{device.achievements.chase.state=="enabled" or device.achievements.chase.state=="stopped"}
    # Complete the dropbank after hagalaz is enabled to begin hagalaz
    - start_mode_shadowbroker_hagalaz{device.achievements.hagalaz.state=="enabled" or device.achievements.hagalaz.state=="stopped"}
    # Complete the dropbank after chase to re-enable vasir combat
    # Complete the dropbank after hagalaz to re-enable boss combat
    - enable_shadowbroker_hold{device.achievements.vasir.state=="enabled" or device.achievements.vasir.state=="stopped" or device.achievements.shadowbroker.state=="enabled" or device.achievements.shadowbroker.state=="stopped"}
    # Complete the dropbank after boss is defeated for extra prizes!
    - award_shadowbroker_prize{device.achievements.shadowbroker.state=="completed"}
  # If the mode is restarted and the hold was enabled before, re-enable the hold
  mode_field_started.3{device.achievements.chase.state=="enabled" or device.achievements.chase.state=="stopped" or device.achievements.hagalaz.state=="enabled" or device.achievements.hagalaz.state=="stopped"}:
    - play_shadowbroker_lit_show
  # If filling the dropbank will light the "hold" shot to start vasir/boss, light the shield steady
  mode_field_started.4{device.achievements.vasir.state=="enabled" or device.achievements.vasir.state=="stopped" or device.achievements.shadowbroker.state=="enabled" or device.achievements.shadowbroker.state=="stopped"}:
    - play_shadowbroker_hold_show
  mode_field_started.5{current_player.sbhold_enabled==1}:
    - enable_shadowbroker_hold{device.achievements.vasir.state=="enabled" or device.achievements.vasir.state=="stopped" or device.achievements.shadowbroker.state=="enabled" or device.achievements.shadowbroker.state=="stopped"}
  # ERROR: Hold doesn't work, so use the hold event to fake it holding a ball
  #ball_hold_shadowbroker_hold_held_ball:
  sh_kickback_hit{current_player.sbhold_enabled==1}:
    - enter_shadowbroker_modes
    # Get a ball in the ball hold to begin Vasir
    - start_mode_shadowbroker_vasir{device.achievements.vasir.state=="enabled" or device.achievements.vasir.state=="stopped"}
    # Get a ball in the ball hold to begin Boss Combat
    - start_mode_shadowbroker_boss{device.achievements.shadowbroker.state=="enabled" or device.achievements.shadowbroker.state=="stopped"}
    - disable_shadowbroker_hold
  enable_shadowbroker_hold:
    queue_slide{current_player.sbhold_enabled==0 and (device.achievements.vasir.state=="enabled" or device.achievements.vasir.state=="stopped")}:
      slide: shadowbroker_ready_slide
      mission: Capture Vasir
      mname: vasir
      expire: 5s
      portrait: shadowbroker_vasir_light
    queue_slide{current_player.sbhold_enabled==0 and (device.achievements.shadowbroker.state=="enabled" or device.achievements.shadowbroker.state=="stopped")}:
      slide: shadowbroker_ready_slide
      mission: Final Confrontation
      mname: shadowbroker
      expire: 5s
      portrait: shadowbroker_boss_light

# Use a player variable to mock the hold state of the ball hold
variable_player:
  enable_shadowbroker_hold:
    sbhold_enabled:
      action: set
      int: 1
  disable_shadowbroker_hold:
    sbhold_enabled:
      action: set
      int: 0

show_player:
  mode_field_started:
    sbdrops_show:
      manual_advance: true
      start_step: device.counters.sbdrops_counter.value % 4 + 1
  play_shadowbroker_lit_show:
    shadowbroker_lit_show:
      action: play
      priority: 10
      sync_ms: 1000
  play_shadowbroker_hold_show:
    shadowbroker_hold_show:
      action: play
      priority: 10
  logicblock_sbdrops_counter_hit:
    sbdrops_show:
      action: advance
  achievement_chase_state_enabled:
    shadowbroker_lit_show:
      action: play
      priority: 10
      sync_ms: 1000
  enable_shadowbroker_hold:
    shadowbroker_hold_enabled_show:
      action: play
      sync_ms: 1000
    shadowbroker_hold_show:
      action: stop
  enter_shadowbroker_modes:
    vasir_intro_cineanim{device.achievements.vasir.state=="enabled"}:
      action: play
    boss_intro_cineanim{device.achievements.shadowbroker.state=="enabled"}:
      action: play
    shadowbroker_hold_enabled_show:
      action: stop
  achievement_hagalaz_state_enabled:
    shadowbroker_lit_show:
      action: play
      priority: 10
      sync_ms: 1000
  mode_field_will_stop:
    shadowbroker_lit_show:
      action: stop
    shadowbroker_hold_show:
      action: stop
    shadowbroker_hold_enabled_show:
      action: stop
    sbdrops_show:
      action: stop

shows:
  sbdrops_show:
    - lights:
        l_dropbank_bottom: black
        l_dropbank_middle: black
        l_dropbank_top: black
    - lights:
        l_dropbank_bottom: white
        l_dropbank_middle: black
        l_dropbank_top: black
    - lights:
        l_dropbank_bottom: white
        l_dropbank_middle: white
        l_dropbank_top: black
    - lights:
        l_dropbank_bottom: white
        l_dropbank_middle: white
        l_dropbank_top: white
  shadowbroker_lit_show:
    - duration: 500ms
      lights:
        l_dropbank_bottom: white
        l_dropbank_top: white
        l_dropbank_middle: white
        l_dropbank_shield_rgb:
          color: FF1F00 # color_shadowbroker
          fade: 20ms
    - duration: 500ms
      lights:
        l_dropbank_shield_rgb:
          color: black
          fade: 20ms
  shadowbroker_hold_show:
    - lights:
        l_dropbank_shield_rgb: FF1F00 # color_shadowbroker
  shadowbroker_hold_enabled_show:
    - duration: 500ms
      lights:
        l_kickback_arrow_clear:
          color: on
          fade: 20ms
    - duration: 500ms
      lights:
        l_kickback_arrow_clear:
          color: off
          fade: 20ms
  vasir_intro_cineanim:
    - sounds:
        liara_vasir_its_over:
          action: play
          events_when_stopped: release_shadowbroker_hold, start_mode_shadowbroker_vasir
      lights:
        gi: off
        l_flash_throne: on
  boss_intro_cineanim:
    - sounds:
        boss_intro_cineanim_diag:
          action: play
          events_when_stopped: release_shadowbroker_hold, start_mode_shadowbroker_boss
      lights:
        gi: off
        l_flash_dragon_left: on

slides:
  shadowbroker_ready_slide:
    widgets:
      - type: text
        text: (mission)
        style: header_md, row_main, col_left_anchor
      - type: text
        text: Lair of the Shadow Broker
        style: header_xs, row_top, col_left_anchor
        opacity: 0.5
      - type: text
        text: Hit Lane to Start
        style: header_sm, row_sub, col_left_anchor
        animations:
          show_slide: pulse_text
      - widget: console_background

sound_player:
  shadowbroker_hold_enabled_slide{mname=="vasir"}: vasir_hold_enabled_sounds
  shadowbroker_hold_enabled_slide{mname=="shadowbroker"}:
    boss_intro_cineanim_diag:
      volume: 0.9
      mode_end_action: stop

sound_pools:
  boss_intro_cineanim_diag:
    sounds: boss_your_interference, boss_enough_talk, boss_its_pointless_to_challenge_me, boss_reckless_even_for_you_commander
    type: random_force_all
    track: voice
    ducking:
      target: music
      attenuation: 0.6
      attack: 1s
      release_point: 1s
      release: 1s
  vasir_hold_enabled_sounds:
    sounds: liara_theres_vasirs_car, liara_we_can_climb_over, liara_vasir_its_over, vasir_ive_crashed_on_azure
    type: random_force_all
    track: voice

sounds:
  boss_your_interference:
    file: DLC_EXP_Part01_Int.1058.ogg
    track: voice
  boss_enough_talk:
    file: DLC_EXP_Part01_Int.1059.ogg
    track: voice
  boss_its_pointless_to_challenge_me:
    file: DLC_EXP_Part01_Int.1065.ogg
    track: voice
  boss_you_travel_with_fascinating_companions:
    file: DLC_EXP_Part01_Int.1056.ogg
    track: voice
  boss_reckless_even_for_you_commander:
    file: DLC_EXP_Part01_Int.1089.ogg
    track: voice
  liara_vasir_its_over:
    file: DLC_EXP_Part01_Int.790.ogg
    track: voice
  liara_theres_vasirs_car:
    file: DLC_EXP_Part01_Int.700.ogg
    track: voice
  liara_we_can_climb_over:
    file: DLC_EXP_Part01_Int.702.ogg
    track: voice
  vasir_ive_crashed_on_azure:
    file: DLC_EXP_Part01_Int.699.ogg
    track: voice

widgets:
  portrait_shadowbroker_vasir_light:
    - type: image
      image: portrait_shadowbroker_vasir_light
  portrait_shadowbroker_boss_light:
    - type: image
      image: portrait_shadowbroker_boss_light
