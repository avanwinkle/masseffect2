#config_version=5

#####
# OVERLORD & ARRIVAL LIGHT MODE
#
# This mode handles the ball lock advancement for the Overlord and Arrival
# multiballs, using shots and events to light lock, enable devices, and
# illuminate indicators.
#
# This is a separate mode to help debug the complex multiball_lock/ball_hold
# combo logic, but eventually this mode may be integrated with another base
# or ball-lock common mode.
#####

event_player:
  # This needs to be in event_player because mpf-mc controls sound_player and
  # doesn't have access to machine modes
  fmball_lightshot_hit:
    - play_overlord_hit_sound{device.achievements.arrival.state=="disabled"}
    - play_arrival_hit_sound{device.achievements.arrival.state!="disabled"}|100ms
    # If overlord has not been played, a single hit will light. (Arrival always takes both)
    # We know a mode has been played if it is "stopped" rather than "enabled"
    - enable_fmball_lock{device.achievements.overlord.state=="enabled" and device.achievements.arrival.state=="disabled" and not device.multiball_locks.fmball_lock.enabled}
    # Try this: on normal difficulty, arrival takes one bank to light the first time
    - enable_fmball_lock{device.achievements.arrival.state=="enabled" and current_player.difficulty==0 and not device.multiball_locks.fmball_lock.enabled}
  # If the current multiball HAS been played, only a complete shot group will re-light
  fmball_lightshot_complete{not device.multiball_locks.fmball_lock.enabled}:
    - enable_fmball_lock
  # We don't start the multiball during a mission, so hide the show...
  # ... if a mission starts and 2 balls are locked
  mode_type_mission_started.2{device.multiball_locks.fmball_lock.locked_balls==2}: hide_fmball_lock_show
  # ... or if ball 2 is locked during a mission
  multiball_lock_fmball_lock_locked_ball{total_balls_locked==2 and not mode.field.active}: hide_fmball_lock_show
  # Wait for the queued slide to play
  play_queued_slide_fmball_full_slide:
    # TODO: Use a queue slide to trigger the start of the multiballs
    - start_mode_overlord{device.achievements.arrival.state=="disabled"}
    - start_mode_arrival{device.achievements.arrival.state!="disabled"}

  # QUEUE SLIDES
  enable_fmball_lock.1{mode.field.active and device.achievements.arrival.state=="disabled"}:
    queue_slide:
      slide: fmball_lock_lit_slide
      portrait: overlord_light
      mball_name: overlord
      ball:
        # Using bd_lock.balls includes balls being ejected, which miscounts. Use locked_balls instead?
        value: device.multiball_locks.fmball_lock.locked_balls
        type: int
  enable_fmball_lock.2{mode.field.active and device.achievements.arrival.state!="disabled"}:
    queue_slide:
      slide: fmball_lock_lit_slide
      portrait: arrival_light
      mball_name: arrival
      ball:
        value: device.multiball_locks.fmball_lock.locked_balls
        type: int
  overlord_ball_will_lock.100:
    queue_slide{device.multiball_locks.fmball_lock.locked_balls==1}:
      priority: 1
      slide: fmball_ball_locked_slide
      portrait: overlord_light
      mball_name: overlord
      description: Vulcan Station Cleared
      ball: 1
    queue_slide{device.multiball_locks.fmball_lock.locked_balls==2}:
      priority: 2
      slide: fmball_ball_locked_slide
      portrait: overlord_light
      mball_name: overlord
      description: Prometheus Station Cleared
      ball: 2
    # On full, queue both slides!
    queue_slide{device.multiball_locks.fmball_lock.locked_balls==3}:
      priority: 7
      slide: fmball_ball_locked_slide
      portrait: overlord_light
      mball_name: overlord
      description: Atlas Station Cleared
      ball: 3
  overlord_ball_will_lock.1:
    queue_slide{device.multiball_locks.fmball_lock.locked_balls==3}:
      priority: 6
      slide: fmball_full_slide
      portrait: overlord
      mball_name: overlord
  arrival_ball_will_lock.100:
    queue_slide{device.multiball_locks.fmball_lock.locked_balls==1}:
      priority: 4
      slide: fmball_ball_locked_slide
      portrait: arrival_light
      mball_name: arrival
      description: Med Bay Escaped
      ball: 1
    queue_slide{device.multiball_locks.fmball_lock.locked_balls==2}:
      priority: 5
      slide: fmball_ball_locked_slide
      portrait: arrival_light
      mball_name: arrival
      description: Reactor Online
      ball: 2
    queue_slide{device.multiball_locks.fmball_lock.locked_balls==3}:
      priority: 7
      slide: fmball_ball_locked_slide
      portrait: arrival_light
      mball_name: arrival
      description: Project Activated
      ball: 3
  arrival_ball_will_lock.1:
    queue_slide{device.multiball_locks.fmball_lock.locked_balls==3}:
      priority: 6
      slide: fmball_full_slide
      portrait: arrival
      mball_name: arrival

shot_groups:
  fmball_lightshot:
    shots: light_lock_fmball_top, light_lock_fmball_bottom
    # Since multiballs are wizards, this mode (global) will auto enable/disable the shot with multiballs
    enable_events: enable_lock_lightshot
    disable_events: disable_lock_lightshot
    reset_events:
      - multiball_lock_fmball_lock_locked_ball
      # When we switch from Overlord to Arrival, reset the lock state
      - start_mode_collectorship_base

shots:
  fmball_lock_shot:
    hit_events: sw_lock_entrance_active
    enable_events: enable_fmball_lock
    disable_events:
      - multiball_lock_fmball_lock_locked_ball
      # When we switch from Overlord to Arrival, reset the lock state
      - start_mode_collectorship_base
    profile: color_flashing_static
    show_tokens:
      leds: light_lock_lit
      color: color_mball
  light_lock_fmball_top:
    switch: s_hitbank_top
    profile: hit_to_lit_profile
    show_tokens:
      leds: l_hitbank_top
      color:  color_mball
  light_lock_fmball_bottom:
    switch: s_hitbank_bottom
    profile: hit_to_lit_profile
    show_tokens:
      leds: l_hitbank_bottom
      color:  color_mball

show_player:
  fmball_light_shot_hit:
    fmball_lock_flash:
      priority: 100
      loops: 6
      speed: 10
      show_tokens:
        color: color_mball
  play_queued_slide_fmball_ball_locked_slide{device.achievements.arrival.state=="disabled"}:
    lock_sweep_overlord:
      priority: 10000
      speed: 30
      loops: 1
  play_queued_slide_fmball_ball_locked_slide{device.achievements.arrival.state!="disabled"}:
    lock_sweep_arrival:
      priority: 10000
      speed: 30
      loops: 1
  # When in wizard mode, hide the lock light show because we can't lock
  mode_type_wizard_started:
    fmball_disabled_show:
      priority: 100
  mode_type_wizard_stopped:
    fmball_disabled_show:
      action: stop
  hide_fmball_lock_show:
    fmball_disabled_show:
      priority: 100
  mode_type_mission_stopped:
    fmball_disabled_show:
      action: stop

shows:
  fmball_lock_flash:
    - time: 0
      lights:
        l_hitbank_bottom: (color)
        l_hitbank_top: (color)
    - time: '+1'
      lights:
        l_hitbank_bottom: black
        l_hitbank_top: black
  fmball_disabled_show:
    - lights:
        light_lock_lit: black

slides:
  fmball_lock_lit_slide:
    - type: text
      text: (mball_name)
      style: header_xs, row_top, col_left_anchor, mission_title
      casing: title
    - type: text
      text: Lock is Lit
      style: header_md, row_main, col_left_anchor
    - widget: background_console
  fmball_ball_locked_slide:
    - type: text
      text: (mball_name)
      style: header_xs, row_top, col_left_anchor, mission_title
      casing: title
      opacity: 0.5
    - type: text
      text: Ball (ball) Locked!
      style: header_md, row_main, col_left_anchor
    - type: text
      text: (description)
      style: header_sm, row_sub, col_left_anchor
    - widget: background_console
  fmball_full_slide:
    - type: text
      text: "(mball_name)\nMULTIBALL"
      style: header_lg, row_main
      casing: upper
    - widget: background_console

sound_player:
  #### OVERLORD ####
  play_overlord_hit_sound{not current_player.disable_mball_light_sounds}:
    geth_hit_sfx:
      action: play
      max_queue_time: 200ms
  play_queued_slide_fmball_lock_lit_slide.1{ball==0 and mball_name=="overlord"}:
    archer_need_to_go_to_both:
      action: play
      max_queue_time: 1s
      mode_end_action: stop
  play_queued_slide_fmball_lock_lit_slide.2{ball==1 and mball_name=="overlord"}:
    archer_still_need_to_go_to_prometheus:
      action: play
      max_queue_time: 1s
      mode_end_action: stop
  play_queued_slide_fmball_lock_lit_slide.3{ball==2 and mball_name=="overlord"}:
    archer_lockdown_cancelled:
      action: play
      max_queue_time: 1s
      mode_end_action: stop
  # Sound player doesn't accept conditions in sound names, so conditional events only
  play_queued_slide_fmball_ball_locked_slide.1{ball==1 and mball_name=="overlord"}:
    vulcan_success:
      action: play
      max_queue_time: 2s
  play_queued_slide_fmball_ball_locked_slide.2{ball==2 and mball_name=="overlord"}:
    archer_lockdown_cancelled_short:
      action: play
      max_queue_time: 2s
  play_queued_slide_fmball_ball_locked_slide.3{ball==3 and mball_name=="overlord"}:
    archer_start:
      action: play
  #### ARRIVAL ####
  play_arrival_hit_sound:
    batarian_hit_sfx:
      action: play
      max_queue_time: 200ms
  play_queued_slide_fmball_lock_lit_slide.4{ball==0 and mball_name=="arrival"}:
    arr_ken_keep_shepard_contained:
      action: play
      max_queue_time: 1s
      mode_end_action: stop
  play_queued_slide_fmball_lock_lit_slide.5{ball==1 and mball_name=="arrival"}:
    arr_annc_cooling_rod_a_inserted:
      action: play
      max_queue_time: 1s
      mode_end_action: stop
  play_queued_slide_fmball_lock_lit_slide.6{ball==2 and mball_name=="arrival"}:
    arr_shep_i_wanna_activate_the_project:
      action: play
      max_queue_time: 1s
      mode_end_action: stop
  # Sound player doesn't accept conditions in sound names, so conditional events only
  play_queued_slide_fmball_ball_locked_slide.4{ball==1 and mball_name=="arrival"}:
    arr_ken_shepards_escaped:
      action: play
      max_queue_time: 2s
  play_queued_slide_fmball_ball_locked_slide.5{ball==2 and mball_name=="arrival"}:
    arr_annc_cooling_rod_b_inserted:
      action: play
      max_queue_time: 2s
  play_queued_slide_fmball_ball_locked_slide.6{ball==3 and mball_name=="arrival"}:
    arr_annc_project_activated_collision_imminent:
      action: play

sound_pools:
  geth_hit_sfx:
    sounds: geth_hit_1, geth_hit_2, geth_hit_3, geth_hit_4
    type: random_force_all
    track: sfx
  batarian_hit_sfx:
    sounds: batarian_hit_1, batarian_hit_2, batarian_hit_3, batarian_hit_4
    type: random_force_all
    track: sfx
  vulcan_success:
    sounds: archer_vulcan_success, shepard_hit_override_vulcan
    type: random
    track: voice
    max_queue_time: 1s
  archer_still_need_to_go_to_prometheus:
    sounds: archer_still_need_to_go_to_prometheus_1, archer_still_need_to_go_to_prometheus_2
    type: random
    track: voice
    max_queue_time: 1s
  archer_lockdown_cancelled:
    sounds: archer_lockdown_cancelled_1, archer_lockdown_cancelled_2, archer_lockdown_cancelled_3
    type: random
    track: voice
    max_queue_time: 1s
  archer_start:
    sounds: archer_get_to_server_room, archer_you_have_to_hurry
    type: random_force_all
    track: voice

sounds:
  archer_lockdown_cancelled_1:
    file: DLC_UNC_Pack01_Int.097.ogg
    track: voice
  archer_lockdown_cancelled_2:
    file: DLC_UNC_Pack01_Int.099.ogg
    track: voice
  archer_lockdown_cancelled_3:
    file: DLC_UNC_Pack01_Int.491.ogg
    track: voice
  archer_lockdown_cancelled_short:
    file: DLC_UNC_Pack01_Int.098.ogg
    track: voice
  archer_still_need_to_go_to_vulcan_1:
    file: DLC_UNC_Pack01_Int.100.ogg
    track: voice
  archer_still_need_to_go_to_vulcan_2:
    file: DLC_UNC_Pack01_Int.485.ogg
    track: voice
  archer_still_need_to_go_to_prometheus_1:
    file: DLC_UNC_Pack01_Int.102.ogg
    track: voice
  archer_still_need_to_go_to_prometheus_2:
    file: DLC_UNC_Pack01_Int.487.ogg
    track: voice
  archer_still_need_to_go_to_both:
    file: DLC_UNC_Pack01_Int.104.ogg
    track: voice
  archer_need_to_go_to_both:
    file: DLC_UNC_Pack01_Int.484.ogg
    track: voice
  archer_prometheus_success:
    file: DLC_UNC_Pack01_Int.486.ogg
    track: voice
  archer_vulcan_success:
    file: DLC_UNC_Pack01_Int.488.ogg
    track: voice
  archer_get_to_server_room:
    file: DLC_UNC_Pack01_Int.291.ogg
    track: voice
  archer_you_have_to_hurry:
    file: DLC_UNC_Pack01_Int.012.ogg
    track: voice
  shepard_hit_override_vulcan:
    file: DLC_UNC_Pack01_Int.219.ogg
    track: voice
  vi_override_accepted_atlas_1:
    file: DLC_UNC_Pack01_Int.221.ogg
    track: voice
  vi_override_accepted_atlas_2:
    file: DLC_UNC_Pack01_Int.289.ogg
    track: voice
  geth_hit_1:
    file: sfx_ss_geth_trooper_ss_geth_trooper_00307868_m.ogg
    track: sfx
  geth_hit_2:
    file: sfx_ss_geth_trooper_ss_geth_trooper_00307894_m.ogg
    track: sfx
  geth_hit_3:
    file: sfx_ss_geth_trooper_ss_geth_trooper_00307881_m.ogg
    track: sfx
  geth_hit_4:
    file: sfx_ss_geth_trooper_ss_geth_trooper_00307899_m.ogg
    track: sfx
  batarian_hit_1:
    file: DLC_EXP_Part02_Int.378.ogg
    track: sfx
  batarian_hit_2:
    file: DLC_EXP_Part02_Int.381.ogg
    track: sfx
  batarian_hit_3:
    file: DLC_EXP_Part02_Int.432.ogg
    track: sfx
  batarian_hit_4:
    file: DLC_EXP_Part02_Int.451.ogg
    track: sfx
  arr_ken_keep_shepard_contained:
    file: DLC_EXP_Part02_Int.644.ogg
    track: voice
  arr_ken_shepards_escaped:
    file: DLC_EXP_Part02_Int.244.ogg
    track: voice
  arr_annc_cooling_rod_a_inserted:
    file: DLC_EXP_Part02_Int.599.ogg
    track: voice
  arr_annc_cooling_rod_b_inserted:
    file: DLC_EXP_Part02_Int.023.ogg
    track: voice
  arr_annc_warning_temperature_critical:
    file: DLC_EXP_Part02_Int.004.ogg
    track: voice
  arr_annc_warning_temperature_rising:
    file: DLC_EXP_Part02_Int.017.ogg
    track: voice
  arr_shep_i_wanna_activate_the_project:
    file: DLC_EXP_Part02_Int.674.ogg
    track: voice
  arr_annc_project_activated_collision_imminent:
    file: DLC_EXP_Part02_Int.676.ogg
    track: voice

widgets:
  portrait_overlord_light:
    - type: image
      image: portrait_overlord_light
  portrait_overlord:
    - type: image
      image: portrait_overlord
  portrait_arrival_light:
    - type: image
      image: portrait_arrival_light
  portrait_arrival:
    - type: image
      image: portrait_arrival_phase_1
