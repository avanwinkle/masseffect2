#config_version=5

#####
# JACK RECRUITMENT MISSION
#
# This round-based mode begins with three ramp/orbit shots lit for hurry-up, and
# a timer. Hitting any of the shots stops the hurry-up value depletion (but
# doesnâ€™t stop the timer) and lights the hitbank; hitting the hitbank captures
# the hurry-up value and starts the next round. The second round and third
# rounds have only two hurry-up shots lit. Collecting all three rounds completes
# the mode; the mode ends if the timer expires.
#
# Progress is saved after each round (ramp/orbit shot + hitbank shot).
#####
mode:
  start_events: start_mode_recruitjack
  stop_events: stop_mode_recruitjack, stop_recruitmission, stop_missions
  events_when_started: mode_type_mission_started
  events_when_stopped: mode_type_mission_stopped
  priority: 500

event_player:
  mode_recruitjack_started:
    set_environment:
      env: bluesuns

counters:
  jack_rounds_counter:
    starting_count: 0
    count_complete_value: 3
    count_events: jack_hitbank_shot_hit
    multiple_hit_window: 500ms # In case both hitbanks are hit together
    events_when_complete: recruit_jack_complete
    direction: up
    disable_on_complete: true
    reset_on_complete: false
    persist_state: true

#####
# JACK SCORING:
#    Hurryup starts at 10,000
#    Hit the round shot to stop the hurryup value depletion
#    Hit the hitbank shot to collect the hurryup value and start another round
#    New hurryup is double the collected one [THIS SHOULD CHANGE]
#    3 rounds completes the mission
#    Progress is saved after each round
#####
scoring:
  mode_recruitjack_started:
    temp_hurryup_value:
      action: set
      score: 10000
    # Store the multiplier as the "base" hurryup value to tick off 1/60th of it
    temp_multiplier:
      action: set
      score: 10000
  timer_recruittimer_tick{current_player.temp_multiplier>0}:
    temp_hurryup_value: -1 * current_player.temp_multiplier / 600 * 10
  # Store the build value as the value of the hurry-up at the time it's hit
  jack_hurryup_shots_hit:
    temp_build_value:
      action: set
      score: current_player.temp_hurryup_value
    temp_multiplier:
      action: set
      score: 0
  # Capture the build value and add it to the new hurryup
  jack_hitbank_shot_hit:
    score: current_player.temp_build_value
    temp_hurryup_value:
      action: set
      score: current_player.temp_build_value * 2
    temp_multiplier:
      action: set
      score: current_player.temp_build_value * 2

shot_profiles:
  jack_shots_one_profile:
    show_when_disabled: false
    states:
      - name: lit
        show: jack_shots_one_show
        speed: 2
  jack_shots_two_profile:
    show_when_disabled: false
    states:
      - name: lit
        show: jack_shots_two_show
        speed: 2
        loops: -1
  jack_shots_three_profile:
    show_when_disabled: false
    states:
      - name: lit
        show: jack_shots_three_show
        speed: 3
  jack_hitbank_profile:
    show_when_disabled: false
    states:
      - name: lit
        show: jack_hitbank_show
        speed: 3

shot_groups:
  jack_hurryup_shots:
    shots: jack_shots_one, jack_shots_two, jack_shots_three

shots:
  jack_shots_one:
    hit_events: sh_kickback_hit, sh_left_orbit_hit sh_right_orbit_hit
    profile: jack_shots_one_profile
    enable_events:
      - logicblock_jack_rounds_counter_updated{value==0}
    disable_events: jack_shots_one_hit, mode_recruitjack_started
    tags: envshot_kickback, envshot_left_orbit_exit, envshot_right_orbit_exit
  jack_shots_two:
    hit_events: sh_left_ramp_hit, sh_right_ramp_hit
    profile: jack_shots_two_profile
    enable_events:
      - logicblock_jack_rounds_counter_updated{value==1}
    disable_events: jack_shots_two_hit, mode_recruitjack_started
    tags: envshot_left_ramp_exit, envshot_right_ramp_exit
  jack_shots_three:
    hit_events: sh_left_orbit_hit, sh_right_orbit_hit
    profile: jack_shots_three_profile
    enable_events:
      - logicblock_jack_rounds_counter_updated{value==2}
    disable_events: jack_shots_three_hit, mode_recruitjack_started
    tags: envshot_left_orbit, envshot_right_orbit
  # TODO: Find a way to prevent a double-tap of both hitbanks advancing this
  #       shot (and round counter) twice
  jack_hitbank_shot:
    hit_events: sh_hitbank_top_hit, sh_hitbank_bottom_hit
    profile: jack_hitbank_profile
    enable_events: jack_hurryup_shots_hit
    disable_events: jack_hitbank_shot_hit, mode_recruitjack_started
    tags: envshot_hitbank

shows:
  jack_shots_one_show:
    - time: 0
      lights:
        l_kickback_shield_rgb:
          color: 4D00CC #color_jack
          fade: 20ms
        l_left_orbit_shield_rgb:
          color: 4D00CC #color_jack
          fade: 20ms
        l_right_orbit_shield_rgb:
          color: 4D00CC #color_jack
          fade: 20ms
    - time: '+1'
      lights:
        l_kickback_shield_rgb:
            color: black
            fade: 20ms
        l_left_orbit_shield_rgb:
            color: black
            fade: 20ms
        l_right_orbit_shield_rgb:
            color: black
            fade: 20ms
  jack_shots_two_show:
    - time: 0
      lights:
        l_left_ramp_shield_rgb:
          color: 4D00CC #color_jack
          fade: 20ms
        l_right_ramp_shield_rgb:
          color: 4D00CC #color_jack
          fade: 20ms
    - time: '+1'
      lights:
        l_left_ramp_shield_rgb:
            color: black
            fade: 20ms
        l_right_ramp_shield_rgb:
            color: black
            fade: 20ms
  jack_shots_three_show:
    - time: 0
      lights:
        l_left_orbit_shield_rgb:
          color: 4D00CC #color_jack
          fade: 20ms
        l_right_orbit_shield_rgb:
          color: 4D00CC #color_jack
          fade: 20ms
    - time: '+1'
      lights:
        l_left_orbit_shield_rgb:
            color: black
            fade: 20ms
        l_right_orbit_shield_rgb:
            color: black
            fade: 20ms
  jack_hitbank_show:
    - time: 0
      lights:
        l_hitbank_shield_rgb:
          color: 4D00CC #color_jack
          fade: 20ms
    - time: '+2'
      lights:
        l_hitbank_shield_rgb:
            color: black
            fade: 20ms
    - time: '+2'


slide_player:
  mode_recruitjack_started:
    instructions_slide:
      expire: 3s

slides:
  instructions_slide:
    widgets:
      - type: text
        text: HIT SHOTS TO LIGHT BANK
        style: dmd_small
        anchor_y: bottom
        y: middle+4
        z: 1
      - type: text
        text: 3X BANK HITS TO DEFEAT WARDEN
        style: dmd_small
        anchor_y: top
        y: middle-4
        z: 1
      - type: rectangle
        width: 128
        height: 32
        color: 000000

sound_player:
  jack_shots_one_hit:
    jack_shot_hit_sound:
      action: play
      max_queue_time: 1s
      priority: 100
  jack_shots_two_hit:
    jack_shot_hit_sound:
      action: play
      max_queue_time: 1s
      priority: 100
  jack_shots_three_hit:
    jack_shot_hit_sound:
      action: play
      max_queue_time: 1s
      priority: 100
  logicblock_jack_rounds_counter_hit{count==1}:
    warden_shepard_1:
      action: play
      max_queue_time: 1s
      priority: 100
  logicblock_jack_rounds_counter_hit{count==2}:
    warden_shepard_2:
      action: play
      max_queue_time: 1s
      priority: 100
  mode_recruitjack_started:
    music_recruit_jack:
      action: play
      loops: -1
    warden_start:
      action: play
  recruit_jack_complete:
    music_recruit_jack:
      action: stop

sound_pools:
  jack_shot_hit_sound:
    sounds: warden_guards_1, warden_guards_2, warden_guards_3
    type: random_force_all
    track: voice

sounds:
  music_recruit_jack:
    file: mus_jack_acq_combat_1.ogg
    track: music
    volume: 0.8
    mode_end_action: stop
    fade_out: 1s
  warden_start:
    file: en_us_prscva_warden_prscva_warden_pa_a_00282485_m.ogg
    track: voice
  warden_guards_1:
    file: en_us_prscva_warden_prscva_warden_pa_a_00254121_m.ogg
    track: voice
  warden_guards_2:
    file: en_us_prscva_warden_prscva_warden_pa_a_00254124_m.ogg
    track: voice
  warden_guards_3:
    file: en_us_prscva_warden_prscva_warden_pa_a_00271737_m.ogg
    track: voice
  warden_shepard_1:
    file: en_us_prscva_warden_prscva_boss_c_00198326_m.ogg
    track: voice
  warden_shepard_2:
    file: en_us_player_f_prscva_boss_c_00198332_f.ogg
    track: voice
