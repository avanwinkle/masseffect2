#config_version=5

#####
# KASUMI RECRUITMENT MISSION
#
# This mode has a hurry-up with one shot lit as “alarmed” and the remaining
# unlit shots as “safe”; hitting any of the safe shot collects the hurry-up and
# advances to the next round (voiceprint, DNA sample, password). With each round
# the just-hit shot becomes alarmed, reducing the number of safe shots. Hitting
# three alarmed shots fails the mode. Hitting four safe shots completes the mode.
#
# Progress is saved after each safe shot hit, and the three-alarm-failure count
# resets each time the mode is started.
#####

mode:
  start_events: start_mode_recruitkasumi
  stop_events: stop_mode_recruitkasumi, stop_recruitmission, stop_missions
  events_when_started: mode_type_mission_started
  events_when_stopped: mode_type_mission_stopped
  priority: 500

event_player:
  mode_recruitkasumi_started:
    set_environment:
      env: kasumi
    show_recruit_instructions:
      squadmate: kasumi
      portrait: recruitkasumi
      instructions_main: Hit 4 Lanes to Enter Vault
      instructions_sub: Don't touch the alarms!
    set_mission_shots:
      shots_total: 4
      is_resumable: 1
      shots_remaining:
        value: device.counters.kasumi_shots_counter.value
        type: int
  slide_recruit_mission_slide_active:
    logicblock_kasumi_shots_counter_updated:
      value:
        value: device.counters.kasumi_shots_counter.value
        type: int
  logicblock_kasumi_shots_counter_hit:
    - sweep_alarms
  logicblock_kasumi_shots_counter_complete:
    - recruit_kasumi_complete

counters:
  # This counter tracks how many unalarmed shots must be hit to succeed
  kasumi_shots_counter:
    starting_count: 4
    count_complete_value: 0
    persist_state: true
    count_events: kasumi_shots_lit_hit
    events_when_hit:
      - logicblock_kasumi_shots_counter_hit
      - mission_shot_hit
      - mission_collect_score
    disable_on_complete: true
    reset_on_complete: false
    direction: down
  # This counter tracks how many alarmed shots are hit before failure
  kasumi_alarms_counter:
    starting_count: 3
    count_complete_value: 0
    count_events: kasumi_shots_off_hit
    reset_events: mode_recruitkasumi_started
    events_when_complete: stop_recruitmission
    persist_state: false
    direction: down

shot_groups:
  kasumi_shots:
    shots: kasumi_left_orbit, kasumi_left_ramp, kasumi_right_orbit, kasumi_right_ramp, kasumi_kickback

shot_profiles:
  alarmed_shot_profile:
    show_when_disabled: false
    states:
      - name: lit
        show: unalarmed_show
      - name: off
        show: alarmed_show
        sync_ms: 2400

shots:
  kasumi_left_orbit:
    hit_events: sh_left_orbit_hit
    profile: alarmed_shot_profile
    advance_events: set_alarm_left_orbit
    show_tokens:
      arrow_led: light_lane_left_orbit
      lane_led: l_left_orbit_shield_rgb
    tags: alarmshot, envshot_left_orbit, power_target, power_target_left_orbit
  kasumi_left_ramp:
    hit_events: sh_left_ramp_hit
    profile: alarmed_shot_profile
    advance_events: set_alarm_left_ramp, mode_recruitkasumi_started  # Starting shot
    show_tokens:
      arrow_led: light_lane_left_ramp
      lane_led: l_left_ramp_shield_rgb
    tags: alarmshot, envshot_left_ramp, power_target, power_target_left_ramp
  kasumi_right_orbit:
    hit_events: sh_right_orbit_hit
    profile: alarmed_shot_profile
    advance_events: set_alarm_right_orbit
    show_tokens:
      arrow_led: light_lane_right_orbit
      lane_led: l_right_orbit_shield_rgb
    tags: alarmshot, envshot_right_orbit, power_target, power_target_right_orbit
  kasumi_right_ramp:
    hit_events: sh_right_ramp_hit
    profile: alarmed_shot_profile
    advance_events: set_alarm_right_ramp
    show_tokens:
      arrow_led: light_lane_right_ramp
      lane_led: l_right_ramp_shield_rgb
    tags: alarmshot, envshot_right_ramp, power_target, power_target_right_ramp
  kasumi_kickback:
    hit_events: sh_kickback_hit
    profile: alarmed_shot_profile
    advance_events: set_alarm_kickback
    show_tokens:
      arrow_led: light_lane_kickback
      lane_led: l_kickback_shield_rgb
    tags: alarmshot, envshot_kickback, power_target, power_target_kickback

show_player:
  mode_recruitkasumi_started:
    kasumi_gi_show:
      action: play
      loops: -1
  mode_recruitkasumi_will_stop:
    kasumi_gi_show:
      action: stop
  logicblock_kasumi_alarms_counter_hit:
    flash_color_show:
      action: play
      speed: 9
      loops: 3
      show_tokens:
        leds: light_flash_alarm
        color: color_kasumi_alarm
    color_flashing_fast:
      action: play
      loops: 3
      speed: 4
      priority: 100
      show_tokens:
        leds: shot_shields
        color: color_health
  sweep_alarms:
    alarm_sweep_show:
      action: play
      priority: 100
      loops: 0
      speed: 60

shows:
  # Dim the general illumination to make it feel more heist-y
  kasumi_gi_show:
    - duration: 1s
      lights:
        gi:
          color: 000000
          fade: 500ms
    - duration: 1s
      lights:
        l_gi_upper:
          color: 000000
          fade: 500ms
        l_gi_left_playfield:
          color: 444444
          fade: 500ms
        l_gi_lower_playfield:
          color: BBBBBB
          fade: 500ms
  # Tricky! The shots to hit are the ones that AREN'T lit
  unalarmed_show:
    - time: 0
      lights:
        (arrow_led): off
        (lane_led): color_kasumi%30
  # A nice pulse for the red lights, not blinking or ever fully off
  alarmed_show:
    - duration: 1200ms
      lights:
        (arrow_led):
          color: color_kasumi_alarm
          fade: 800ms
        (lane_led):
          color: off
    - duration: 1200ms
      lights:
        (arrow_led):
          color: 000000
          fade: 800ms
  alarm_sweep_show:
    - time: 0
      lights:
        light_lane_left_orbit: color_kasumi_alarm
        light_lane_kickback: black
        light_lane_left_ramp: black
        light_lane_right_ramp: black
        light_lane_right_orbit: color_kasumi_alarm
    - time: '+1'
      lights:
        light_lane_left_orbit: black
        light_lane_kickback: color_kasumi_alarm
        light_lane_left_ramp: black
        light_lane_right_ramp: color_kasumi_alarm
        light_lane_right_orbit: black
    - time: '+1'
      lights:
        light_lane_left_orbit: color_kasumi_alarm
        light_lane_kickback: black
        light_lane_left_ramp: black
        light_lane_right_ramp: black
        light_lane_right_orbit: color_kasumi_alarm
    - time: '+1'
      lights:
        light_lane_left_orbit: black
        light_lane_kickback: color_kasumi_alarm
        light_lane_left_ramp: black
        light_lane_right_ramp: color_kasumi_alarm
        light_lane_right_orbit: black
    - time: '+1'

slide_player:
  recruit_kasumi_failed:
    kasumi_failed_slide:
      expire: 5s
  # Until MC supports priority and condition, deal with duplicate warnings
  logicblock_kasumi_shots_counter_hit{count==3}:
    kasumi_slide_1:
      expire: 3s
  logicblock_kasumi_shots_counter_hit{count==2}:
    kasumi_slide_2:
      expire: 3s
  logicblock_kasumi_shots_counter_hit{count==1}:
    kasumi_slide_3:
      expire: 3s
  logicblock_kasumi_shots_counter_hit{count==0}:
    kasumi_slide_4:
      expire: 3s
  logicblock_kasumi_alarms_counter_hit{count>0}:
    kasumi_alarm_slide:
      action: play
      expire: 3s
  logicblock_kasumi_alarms_counter_hit{count==0}:
    kasumi_failed_slide:
      action: play
      expire: 3s

slides:
  kasumi_slide_1:
    widgets:
      - type: text
        text: Password Obtained
        style: body_lg
  kasumi_slide_2:
    widgets:
      - type: text
        text: Voiceprint Recorded
        style: body_lg
  kasumi_slide_3:
    widgets:
      - type: text
        text: DNA Sample Obtained
        style: body_lg
  kasumi_slide_4:
    widgets:
      - type: text
        text: Barrier Deactivated
        style: body_lg
  kasumi_alarm_slide:
    widgets:
      - type: text
        text: "Alarm Tripped!"
        style: body_lg, row_main
      - type: text
        text: "(count) until failure"
        style: body_md, row_sub
  kasumi_failed_slide:
    widgets:
      - type: text
        text: FAILED!
        style: body_lg

sound_player:
  mode_recruitkasumi_started:
    recruit_music_kasumi_1:
      action: play
      loops: -1
      fade_in: 1s
    kasumi_need_password_and_voice:
      action: play
  # Alarm hit
  logicblock_kasumi_alarms_counter_hit:
    kasumi_careful:
      max_queue_time: 2s
  # First shot hit, got the password
  logicblock_kasumi_shots_counter_hit{count==3}:
    kasumi_password_complete:
      max_queue_time: 2s
  # Second shot hit, got the voice print
  logicblock_kasumi_shots_counter_hit{count==2}:
    kasumi_voice_complete:
      max_queue_time: 2s
  # Third shot hit, got the DNA sample
  logicblock_kasumi_shots_counter_hit{count==1}:
    kasumi_not_great_saliva_sample:
      max_queue_time: 2s
  # Fourth shot hit, get the barrier down
  logicblock_kasumi_shots_counter_hit{count==0}:
    kasumi_barrier_is_down:
      max_queue_time: 2s

sound_pools:
  kasumi_careful:
    type: random
    sounds:
      - kasumi_careful_barrier_up
      - kasumi_hey_no_touching
      - kasumi_dont_touch_that_without_dna_set_off_alarm
      - kasumi_try_again
      - shepard_damn
    track: voice
  kasumi_password_complete:
    type: random
    sounds:
      - kasumi_weve_got_the_password_need_voice
      - kasumi_still_need_password_and_voice
      - shepard_password_is_perrugia
    track: voice
  kasumi_voice_complete:
    type: random
    sounds: kasumi_got_voice, kasumi_lets_crack_voice
    track: voice

sounds:
  recruit_music_kasumi_1:
    file: KAS.03.Infiltration.ogg
    track: music
    volume: 0.6
    mode_end_action: stop
    fade_out: 1s
  recruit_music_kasumi_2:
    file: KAS.02.Making_Our_Escape.ogg
    track: music
    mode_end_action: stop
    fade_out: 1s
  recruit_music_kasumi_3:
    file: KAS.01.Death_from_Above.ogg
    track: music
    mode_end_action: stop
    fade_out: 1s
    fade_in: 1s
    start_at: 15s
  kasumi_list_of_items:
    file: DLC_HEN_MT_Int.468.ogg
    track: voice
    ducking:
      target: music
      attenuation: 0.5
      attack: 200ms
      release_point: 200ms
      release: 500ms
  kasumi_barrier_is_down:
    file: DLC_HEN_MT_Int.446.ogg
    track: voice
  kasumi_got_voice:
    file: DLC_HEN_MT_Int.555.ogg
    track: voice
    ducking:
      target: music
      attenuation: 0.5
      attack: 200ms
      release_point: 200ms
      release: 500ms
  kasumi_lets_crack_voice:
    file: DLC_HEN_MT_Int.592.ogg
    track: voice
  kasumi_need_dna:
    file: DLC_HEN_MT_Int.453.ogg
    track: voice
  kasumi_look_for_dna:
    file: DLC_HEN_MT_Int.665.ogg
    track: voice
  kasumi_not_great_saliva_sample:
    file: DLC_HEN_MT_Int.678.ogg
    track: voice
    ducking:
      target: music
      attenuation: 0.5
      attack: 200ms
      release_point: 200ms
      release: 500ms
  kasumi_that_should_do_it: # Done with DNA but not explicit
    file: DLC_HEN_MT_Int.657.ogg
    track: voice
  kasumi_need_password_and_voice:
    file: DLC_HEN_MT_Int.415.ogg
    track: voice
  kasumi_weve_got_the_password_need_voice:
    file: DLC_HEN_MT_Int.417.ogg
    track: voice
  kasumi_still_need_password_and_voice:
    file: DLC_HEN_MT_Int.420.ogg
    track: voice
  kasumi_still_need_voice_1:
    file: DLC_HEN_MT_Int.422.ogg
    track: voice
  kasumi_still_need_voice_2:
    file: DLC_HEN_MT_Int.437.ogg
    track: voice
  kasumi_this_is_where_your_special_skills:
    file: DLC_HEN_MT_Int.779.ogg
    track: voice
  kasumi_damn_you_hock:
    file: DLC_HEN_MT_Int.794.ogg
    track: voice
  kasumi_careful_barrier_up:
    file: DLC_HEN_MT_Int.440.ogg
    track: voice
  kasumi_dont_touch_that_without_dna_set_off_alarm:
    file: DLC_HEN_MT_Int.451.ogg
    track: voice
  kasumi_hey_no_touching:
    file: DLC_HEN_MT_Int.452.ogg
    track: voice
  kasumi_damn:
    file: DLC_HEN_MT_Int.176.ogg
    track: voice
  kasumi_try_again:
    file: DLC_HEN_MT_Int.174.ogg
    track: voice
  # guard_room_off_limits:
  #   file: DLC_HEN_MT_Int.681.ogg
  #   track: voice
  # guard_i_told_you_room_off_limits:
  #   file: DLC_HEN_MT_Int.683.ogg
  #   track: voice
  # guard_turn_around_now:
  #   file: DLC_HEN_MT_Int.691.ogg
  #   track: voice
  # guard_you_stop:
  #   file: DLC_HEN_MT_Int.717.ogg
  #   track: voice
  shepard_password_is_perrugia:
    file: DLC_HEN_MT_Int.442.ogg
    track: voice
  shepard_damn:
    file: DLC_HEN_MT_Int.669.ogg
    track: voice

light_player:
  mode_recruitkasumi_started:
    light_backwall_ambient:
      color: color_kasumi%30
