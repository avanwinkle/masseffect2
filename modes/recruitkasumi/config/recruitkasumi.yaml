#config_version=5

#####
# KASUMI RECRUITMENT MISSION
#
# This mode has a hurry-up with one shot lit as “alarmed” and the remaining
# unlit shots as “safe”; hitting any of the safe shot collects the hurry-up and
# advances to the next round (voiceprint, DNA sample, password). With each round
# the just-hit shot becomes alarmed, reducing the number of safe shots. Hitting
# three alarmed shots fails the mode. Hitting four safe shots completes the mode.
#
# Progress is saved after each safe shot hit, and the three-alarm-failure count
# resets each time the mode is started.
#####

mode:
  start_events: start_mode_recruitkasumi
  stop_events: stop_mode_recruitkasumi, stop_recruitmission
  events_when_started: mode_type_mission_started
  events_when_stopped: mode_type_mission_stopped
  priority: 500

counters:
  # This counter tracks how many unalarmed shots must be hit to succeed
  kasumi_shots_counter:
    starting_count: 0
    count_complete_value: 4
    persist_state: true
    count_events:
      - left_orbit_unalarmed_hit
      - left_ramp_unalarmed_hit
      - right_orbit_unalarmed_hit
      - right_ramp_unalarmed_hit
      - kickback_unalarmed_hit
    disable_on_complete: true
    reset_on_complete: false
    direction: up
  # This counter tracks how many alarmed shots are hit before failure
  kasumi_alarms_counter:
    starting_count: 3
    count_complete_value: 0
    count_events:
      - left_orbit_alarmed_hit
      - left_ramp_alarmed_hit
      - right_orbit_alarmed_hit
      - right_ramp_alarmed_hit
      - kickback_alarmed_hit
    reset_events: mode_recruitkasumi_started
    events_when_complete: kasumi_failed
    persist_state: false
    direction: down

event_player:
  mode_recruitkasumi_started:
    # - sweep_alarms
    - set_alarm_left_ramp
  kasumi_failed:
    - stop_recruitmission
    - recruit_mission_ended
  logicblock_kasumi_shots_counter_complete:
    - recruit_kasumi_complete

#####
# KASUMI SCORING:
#    Hurryup starts at 8,000
#    Hit any unalarmed shot to collect the hurryup value
#    New hurryup is 8,000 plus previously-collected value (resets on restart)
#    Hurryup depletion scales (bigger hurryup => faster depletion)
#    4 unalarmed shots completes the mission
#    Score is collected after each shot
#####
scoring:
  mode_recruitkasumi_started:
    temp_hurryup_value:
      action: set
      score: 8000
    temp_multiplier:
      action: set
      score: 8000 / 59
  timer_recruittimer_tick{current_player.temp_multiplier>0}:
    temp_hurryup_value: -1 * current_player.temp_multiplier
  logicblock_kasumi_shots_counter_hit:
    score: current_player.temp_hurryup_value
    temp_hurryup_value:
      action: set
      score: current_player.temp_hurryup_value + 8000
    temp_multiplier:
      action: set
      score: (current_player.temp_hurryup_value + 8000) / 59

shot_groups:
  kasumi_shots:
    shots: left_orbit, left_ramp, right_orbit, right_ramp, kickback

shot_profiles:
  alarmed_shot_profile:
    show_when_disabled: false
    states:
      - name: unalarmed
        show: unalarmed_show
      - name: alarmed
        show: alarmed_show
        sync_ms: 700

shots:
  left_orbit:
    hit_events: sh_left_orbit_hit
    profile: alarmed_shot_profile
    tags: alarmshot
    advance_events: set_alarm_left_orbit
    show_tokens:
      led: l_left_orbit_arrow_red
  left_ramp:
    hit_events: sh_left_ramp_hit
    profile: alarmed_shot_profile
    tags: alarmshot
    advance_events: set_alarm_left_ramp
    show_tokens:
      led: l_left_ramp_arrow_red
  right_orbit:
    hit_events: sh_right_orbit_hit
    profile: alarmed_shot_profile
    tags: alarmshot
    advance_events: set_alarm_right_orbit
    show_tokens:
      led: l_right_orbit_arrow_red
  right_ramp:
    hit_events: sh_right_ramp_hit
    profile: alarmed_shot_profile
    tags: alarmshot
    advance_events: set_alarm_right_ramp
    reset_events: counter_kasumi_shots_counter_complete
    show_tokens:
      led: l_right_ramp_arrow_red
  kickback:
    hit_events: sh_kickback_hit
    profile: alarmed_shot_profile
    tags: alarmshot
    advance_events: set_alarm_kickback
    show_tokens:
      led: l_kickback_arrow_red

show_player:
  mode_recruitkasumi_started:
    kasumi_gi_show:
      action: play
      loops: 0
  mode_recruitkasumi_stopping:
    kasumi_gi_show:
      action: stop
  sweep_alarms:
    alarm_sweep_show:
      action: play
      priority: 100
      loops: 1
      speed: 10

shows:
  # Dim the general illumination to make it feel more heist-y
  kasumi_gi_show:
    - time: 0
      lights:
        gi: FFFFFF
    - time: 1s
      lights:
        l_gi_upper:
          color: 000000
          fade: 1s
        l_gi_left_playfield:
          color: 444444
          fade: 1s
        l_gi_lower_playfield:
          color: 888888
          fade: 1s
  # Tricky! The shots to hit are the ones that AREN'T lit
  unalarmed_show:
    - time: 0
      lights:
        (led): black
  # A nice pulse for the red lights, not blinking or ever fully off
  alarmed_show:
    - duration: 300ms
      lights:
        (led):
          color: FFFFFF
          fade: 150ms
    - duration: 300ms
      lights:
        (led):
          color: 888888
          fade: 150ms
  alarm_sweep_show:
    - time: 0
      lights:
        l_left_ramp_arrow_red: white
        l_left_orbit_arrow_red: black
        l_right_orbit_arrow_red: black
        l_right_ramp_arrow_red: black
        l_kickback_arrow_red: black
    - time: '+1'
      lights:
        l_left_ramp_arrow_red: black
        l_right_orbit_arrow_red: white
    - time: '+2'
      lights:
        l_left_orbit_arrow_red: black
        l_kickback_arrow_red: white
    - time: '+3'
      lights:
        l_right_ramp_arrow_red: white
        l_kickback_arrow_red: black
    - time: '+4'
      lights:
        l_left_orbit_arrow_red: white
        l_right_ramp_arrow_red: black

slide_player:
  mode_recruitkasumi_started:
    kasumi_instructions_slide:
      expire: 3s
  kasumi_failed:
    kasumi_failed_slide:
      expire: 5s
  logicblock_kasumi_shots_counter_hit{value==1}:
    kasumi_slide_1:
      expire: 3s
  logicblock_kasumi_shots_counter_hit{value==2}:
    kasumi_slide_2:
      expire: 3s
  logicblock_kasumi_shots_counter_hit{value==3}:
    kasumi_slide_3:
      expire: 3s
  logicblock_kasumi_alarms_counter_hit:
    kasumi_alarm_slide:
      expire: 3s

slides:
  kasumi_instructions_slide:
    widgets:
      - type: text
        text: Infiltrate Hock's Vault
        font_name: pixelmix-8
        font_size: 8
        anchor_y: bottom
        y: middle+2
        z: 1
      - type: text
        text: Avoid the Alarms
        font_name: pixelmix-8
        font_size: 8
        anchor_y: top
        y: middle-2
        z: 1
  kasumi_slide_1:
    widgets:
      - type: text
        text: Voiceprint Recorded
  kasumi_slide_2:
    widgets:
      - type: text
        text: DNA Sample Obtained
  kasumi_slide_3:
    widgets:
      - type: text
        text: "Password: Perrugia"
  kasumi_alarm_slide:
    widgets:
      - type: text
        text: "Alarm Tripped!"
        anchor_y: bottom
        y: middle+2
      - type: text
        text: "(value) until failure"
        anchor_y: top
        y: middle-2
  kasumi_failed_slide:
    widgets:
      - type: text
        text: FAILED!

sound_player:
  mode_recruitkasumi_started:
    recruit_music_kasumi_1:
      action: play
      loops: -1
  # First alarm hit, increase the music tension
  logicblock_kasumi_alarms_counter_hit{value==1}:
    recruit_music_kasumi_1:
      action: stop
    recruit_music_kasumi_2:
      action: play
  # Second alarm hit, more tension
  logicblock_kasumi_alarms_counter_hit{value==2}:
    recruit_music_kasumi_2:
      action: stop
    recruit_music_kasumi_3:
      action: play

sounds:
  recruit_music_kasumi_1:
    file: "03 Infiltration.ogg"
    track: music
    mode_end_action: stop
    fade_out: 1s
  recruit_music_kasumi_2:
    file: "02 Making Our Escape.ogg"
    track: music
    mode_end_action: stop
    fade_out: 1s
  recruit_music_kasumi_3:
    file: "01 Death from Above.ogg"
    track: music
    mode_end_action: stop
    fade_out: 1s
    fade_in: 1s
    start_at: 15s
  kasumi_list_of_items:
    file: DLC_HEN_MT_Int.468.ogg
    track: voice
  kasumi_barrier_is_down:
    file: DLC_HEN_MT_Int.446.ogg
    track: voice
  kasumi_got_voice:
    file: DLC_HEN_MT_Int.555.ogg
    track: voice
  kasumi_lets_crack_voice:
    file: DLC_HEN_MT_Int.592.ogg
    track: voice
  kasumi_need_dna:
    file: DLC_HEN_MT_Int.453.ogg
    track: voice
  kasumi_look_for_dna:
    file: DLC_HEN_MT_Int.665.ogg
    track: voice
  kasumi_not_great_saliva_sample:
    file: DLC_HEN_MT_Int.678.ogg
    track: voice
  kasumi_that_should_do_it: # Done with DNA but not explicit
    file: DLC_HEN_MT_Int.657.ogg
    track: voice
  kasumi_need_password_and_voice:
    file: DLC_HEN_MT_Int.415.ogg
    track: voice
  kasumi_weve_got_the_password_need_voice:
    file: DLC_HEN_MT_Int.417.ogg
    track: voice
  kasumi_still_need_password_and_voice:
    file: DLC_HEN_MT_Int.420.ogg
    track: voice
  kasumi_still_need_voice_1:
    file: DLC_HEN_MT_Int.422.ogg
    track: voice
  kasumi_still_need_voice_2:
    file: DLC_HEN_MT_Int.437.ogg
    track: voice
  kasumi_this_is_where_your_special_skills:
    file: DLC_HEN_MT_Int.779.ogg
    track: voice
  kasumi_damn_you_hock:
    file: DLC_HEN_MT_Int.794.ogg
    track: voice
  kasumi_damn_it_we_have_to_find_another_way:
    file: DLC_HEN_MT_Int.817.ogg
    track: voice
  kasumi_careful_barrier_up:
    file: DLC_HEN_MT_Int.440.ogg
    track: voice
  kasumi_dont_touch_that_without_dna_set_off_alarm:
    file: DLC_HEN_MT_Int.451.ogg
    track: voice
  kasumi_hey_no_touching:
    file: DLC_HEN_MT_Int.452.ogg
    track: voice
  guard_room_off_limits:
    file: DLC_HEN_MT_Int.681.ogg
    track: voice
  guard_i_told_you_room_off_limits:
    file: DLC_HEN_MT_Int.683.ogg
    track: voice
  guard_turn_around_now:
    file: DLC_HEN_MT_Int.691.ogg
    track: voice
  guard_you_stop:
    file: DLC_HEN_MT_Int.717.ogg
    track: voice
  shepard_password_is_perrugia:
    file: DLC_HEN_MT_Int.442.ogg
    track: voice
  shepard_damn:
    file: DLC_HEN_MT_Int.669.ogg
    track: voice


