#config_version=5

#####
# LEGION RECRUIT MISSION
#
# This mode is a "tower defense" game where a random lane shot is lit and the
# player has 10s to hit it. If the timer runs out, the lane's corresponding
# standup target is lit and the player has 10s to hit both the target and the
# lane. If that 10s runs out, either the dropbank or hitbank is lit.
#
# The mode advances based on a "hacking" progress counter. Each lane/target
# shot hit increments the counter by (20 - shot alive time), so hitting a shot
# when it lights is worth 20 while hitting it just before it moves to the bank
# is worth 1. Bank shots are worth zero, but even worse: when a bank is lit,
# ALL shots are worth zero!
#
# The mode is complete when the hack reaches... 60?
# Progress is saved after each shot is hit.
#####

mode:
  start_events: start_mode_recruitlegion
  stop_events: stop_mode_recruitlegion, stop_recruitmission, stop_missions
  # We use the banks as a shot target, so disable the drops and lock hits
  events_when_started: mode_type_mission_started, disable_sbdrops_counter, disable_lock_lightshot
  events_when_stopped: mode_type_mission_stopped, enable_sbdrops_counter, enable_lock_lightshot
  code: recruitlegion.RecruitLegion
  priority: 500

event_player:
  mode_recruitlegion_started.2:
    set_environment:
      env: geth
    show_recruit_instructions:
      squadmate: legion
      portrait: recruitlegion
      instructions_main: 3 shots to hack heretics
      instructions_sub: Lockout after 10 secs
    set_mission_shots:
      is_resumable: 0
      shots_total: 5
      ticks: 60
  mode_recruitlegion_started.1:
    - play_opening_heretic_dialogue
    - enable_random_heretic
  timer_heretic_timer_complete:
    - enable_random_heretic
  enable_heretic_shot_dropbank.2:
    - reset_dropbank
  player_shot_heretic_shot_dropbank_enabled{value==True}:
    play_squadmate_sound:
      sound: target_left
      variants: 2
  player_shot_heretic_shot_hitbank_enabled{value==True}:
    play_squadmate_sound:
      sound: target_right
      variants: 2
  # Set legion recruited but only "success" on kickback
  player_heretic_progress{value>=60}:
    - recruit_legion_precomplete
    - mission_collect_score
    # It's mean to enable the bonus shot with only a few seconds to spare :(
    - missiontimer_set_12{device.timers.missiontimer.ticks<12}
  # The bonus shot is worth another shot, collected immediately
  heretic_jackpot_shot_hit:
    - mission_shot_hit
    - mission_collect_score
    - recruit_legion_complete

random_event_player:
  enable_random_heretic:
    events:
      - enable_heretic_shot_left_orbit
      - enable_heretic_shot_kickback
      - enable_heretic_shot_left_ramp
      - enable_heretic_shot_right_ramp
      - enable_heretic_shot_right_orbit

light_player:
  mode_recruitlegion_started:
    light_backwall_ambient:
      color: color_legion

counters:
  hacking_counter:
    starting_count: 0
    direction: up
    count_events: heretic_sequence_shots_lit_hit
    events_when_hit: mission_shot_hit

variable_player:
  mode_recruitlegion_started:
    temp_multiplier:
      action: set
      float: 1.0
  # Disable scoring when a bank shot is enabled
  player_shot_heretic_shot_dropbank_enabled:
    temp_multiplier:
      action: set
      float: 0.0
  player_shot_heretic_shot_hitbank_enabled:
    temp_multiplier:
      action: set
      float: 0.0
  # Re-enable scoring when both banks are off
  heretic_banks_off_complete:
    temp_multiplier:
      action: set
      float: 1.0

timers:
  heretic_timer:
    # Just one big tick is enough, we don't need events every second
    start_value: 1
    end_value: 0
    tick_interval: 10s
    direction: down
    start_running: false
    control_events:
      - event: mode_recruitlegion_started
        action: restart
        # Restart on a random shot enabled, whether by the timer expiring or
        # the player clearing all shots and triggering a new one
      - event: enable_random_heretic
        action: restart
      - event: enable_heretic_banks
        action: stop
        # Restart the timer when all shots in heretic_banks are off
      - event: heretic_banks_off_complete
        action: restart
      - event: recruit_legion_precomplete
        action: stop

shot_groups:
  heretic_banks:
    shots: heretic_shot_dropbank, heretic_shot_hitbank
    enable_events: []
    disable_events: mode_recruitlegion_started, heretic_banks_hit

shots:
  heretic_jackpot_shot:
    hit_events: sh_kickback_hit
    enable_events: recruit_legion_precomplete
    profile: color_flashing_fast_profile
    show_tokens:
      leds: l_kickback_shield_rgb
      color: color_legion
    tags: envshot_kickback
  # Dropbank and hitbank are "recovery" shots
  heretic_shot_dropbank:
    hit_events: sh_dropbank_top_hit, sh_dropbank_middle_hit, sh_dropbank_bottom_hit
    enable_events:
      - heretic_shot_left_orbit_timeout
      - heretic_shot_kickback_timeout
    disable_events: mode_recruitlegion_started, recruit_legion_precomplete
    profile: color_flashing_fast_static
    show_tokens:
      leds: light_dropbank_rgb
      color: color_legion
    tags: envshot_dropbank, power_target_charge
  heretic_shot_hitbank:
    hit_events: sh_hitbank_top_hit, sh_hitbank_bottom_hit
    enable_events:
      - heretic_shot_left_ramp_timeout
      - heretic_shot_right_ramp_timeout
      - heretic_shot_right_orbit_timeout
    disable_events: mode_recruitlegion_started, recruit_legion_precomplete
    profile: color_flashing_fast_static
    show_tokens:
      leds: light_hitbank_rgb
      color: color_legion
    tags: envshot_hitbank, power_target_charge
  # Main shots
  heretic_shot_left_orbit:
    switches: s_target1
    hit_events: sh_left_orbit_hit
    advance_events: heretic_shot_left_orbit_advance
    disable_events:
      - mode_recruitlegion_started
      - recruit_legion_precomplete
    restart_events: enable_heretic_shot_left_orbit
    profile: heretic_profile
    show_tokens:
      led_lane: l_left_orbit_shield_rgb
      led_target: l_standup_1
      shot: left_orbit
    tags: envshot_left_orbit, power_target, power_target_left_orbit
  heretic_shot_kickback:
    switches: s_target1
    hit_events: sh_kickback_hit
    advance_events: heretic_shot_kickback_advance
    disable_events:
      - mode_recruitlegion_started
      - recruit_legion_precomplete
    restart_events: enable_heretic_shot_kickback
    profile: heretic_profile
    show_tokens:
      led_lane: l_kickback_shield_rgb
      led_target: l_standup_2
      shot: kickback
    tags: envshot_kickback, power_target, power_target_kickback
  heretic_shot_left_ramp:
    switches: s_target1
    hit_events: sh_left_ramp_hit
    advance_events: heretic_shot_left_ramp_advance
    disable_events:
      - mode_recruitlegion_started
      - recruit_legion_precomplete
    restart_events: enable_heretic_shot_left_ramp
    profile: heretic_profile
    show_tokens:
      led_lane: l_left_ramp_shield_rgb
      led_target: l_standup_3
      shot: left_ramp
    tags: envshot_left_ramp, power_target, power_target_left_ramp
  heretic_shot_right_ramp:
    switches: s_target5
    hit_events: sh_right_ramp_hit
    advance_events: heretic_shot_right_ramp_advance
    disable_events:
      - mode_recruitlegion_started
      - recruit_legion_precomplete
    restart_events: enable_heretic_shot_right_ramp
    profile: heretic_profile
    show_tokens:
      led_lane: l_right_ramp_shield_rgb
      led_target: l_standup_4
      shot: right_ramp
    tags: envshot_right_ramp, power_target, power_target_right_ramp
  heretic_shot_right_orbit:
    switches: s_target5
    hit_events: sh_right_orbit_hit
    advance_events: heretic_shot_right_orbit_advance
    disable_events:
      - mode_recruitlegion_started
      - recruit_legion_precomplete
    restart_events: enable_heretic_shot_right_orbit
    profile: heretic_profile
    show_tokens:
      led_lane: l_right_orbit_shield_rgb
      led_target: l_standup_5
      shot: right_orbit
    tags: envshot_right_orbit, power_target, power_target_right_orbit

shot_profiles:
  heretic_profile:
    advance_on_hit: false
    show_when_disabled: false
    states:
      - name: lit
        show: heretic_lane_show
        sync_ms: 500
      - name: lit
        show: heretic_lane_show_fast
        sync_ms: 500
      - name: lit_target
        show: heretic_target_show
        sync_ms: 500
      - name: lit_target
        show: heretic_target_show_fast
        sync_ms: 500
      - name: timeout
        show: off

shows:
  heretic_lane_show:
    - duration: 500ms
      lights:
        (led_lane): color_legion
        (led_target): off
    - duration: 500ms
      lights:
        (led_lane): off
        (led_target): off
  heretic_lane_show_fast:
    - duration: 250ms
      lights:
        (led_lane): color_legion
        (led_target): off
    - duration: 250ms
      lights:
        (led_lane): off
        (led_target): off
  heretic_target_show:
    - duration: 500ms
      lights:
        (led_lane): off
        (led_target): color_legion
    - duration: 500ms
      lights:
        (led_lane): off
        (led_target): off
  heretic_target_show_fast:
    - duration: 250ms
      lights:
        (led_lane): off
        (led_target): color_legion
    - duration: 250ms
      lights:
        (led_lane): off
        (led_target): off

sound_player:
  mode_recruitlegion_started:
    music_legion:
      action: play
      mode_end_action: stop
  play_opening_heretic_dialogue: shepard_start_your_upload
  # If the progress goes up, play a shot confirmation sound
  player_heretic_progress{change>0}:
    legion_shot_sound:
      max_queue_time: 500ms
  heretic_shot_dropbank_enabled{value==True}:
    legion_warning_left_sound:
      max_queue_time: 1s
  heretic_shot_hitbank_enabled{value==True}:
    legion_warning_right_sound:
      max_queue_time: 1s
  recruit_legion_precomplete:
    legion_hack_complete:
      max_queue_time: 3s
    music_legion_low:
      action: play
      mode_end_action: stop

sound_pools:
  legion_warning_left_sound:
    type: sequential
    track: voice
    sounds:
      - legion_alert_mobile_platforms
      - legion_target_positive_y
      - legion_target_negative_x
  legion_warning_right_sound:
    type: sequential
    track: voice
    sounds:
      - legion_alert_close_combat
      - legion_target_negative_y
      - legion_target_positive_x
  legion_shot_sound:
    type: random_force_all
    track: voice
    sounds:
      - legion_attacking_target
      - legion_hostiles_eliminated
      - legion_targets_eliminated
      - legion_engaging_hostiles
      - legion_attacking_requested_target
      - legion_critical_target_strike
      - legion_enemy_hit
      - legion_successful_shot
      - legion_target_eliminated
      - legion_enemy_disabled

sounds:
  music_legion:
    file: mus_legion_acq_combat_1.ogg
    track: music
    fade_in: 2s
    fade_out: 1s
  music_legion_low:
    file: mus_legion_acq_tension_1.ogg
    track: music
    fade_in: 1s
    fade_out: 1s
  shepard_start_your_upload:
    file: en_us_player_f_gthgtl_core_h_00183211_f.ogg
    track: voice
  legion_alert_mobile_platforms:
    file: en_us_hench_geth_gthgtl_towerdef_h_00183217_m.ogg
    track: voice
    ducking:
      target: music
      attenuation: 0.5
      attack: 50ms
      release: 100ms
      release_point: 50ms
  legion_alert_close_combat:
    file: en_us_hench_geth_gthgtl_towerdef_h_00183218_m.ogg
    track: voice
    ducking:
      target: music
      attenuation: 0.5
      attack: 50ms
      release: 100ms
      release_point: 50ms
  legion_clear_reactivate_defense_turrets:
    file: en_us_hench_geth_gthgtl_towerdef_h_00193277_m.ogg
    track: voice
    ducking:
      target: music
      attenuation: 0.5
      attack: 50ms
      release: 100ms
      release_point: 50ms
  legion_hack_complete:
    file: en_us_hench_geth_gthgtl_towerdef_h_00183219_m.ogg
    track: voice
    ducking:
      target: music
      attenuation: 0.5
      attack: 50ms
      release: 100ms
      release_point: 50ms
  # Hit sounds for lane shots
  legion_attacking_target:
    file: en_us_hench_geth_ss_global_hench_geth_00240680_m.ogg
    track: voice
  legion_hostiles_eliminated:
    file: en_us_hench_geth_ss_global_hench_geth_00240768_m.ogg
    track: voice
  legion_targets_eliminated:
    file: en_us_hench_geth_ss_global_hench_geth_00240769_m.ogg
    track: voice
  legion_engaging_hostiles:
    file: en_us_hench_geth_ss_global_hench_geth_00315342_m.ogg
    track: voice
  legion_attacking_requested_target:
    file: en_us_hench_geth_ss_global_hench_geth_00315352_m.ogg
    track: voice
  legion_critical_target_strike:
    file: en_us_hench_geth_ss_global_hench_geth_00315407_m.ogg
    track: voice
  legion_enemy_hit:
    file: en_us_hench_geth_ss_global_hench_geth_00315451_m.ogg
    track: voice
  legion_successful_shot:
    file: en_us_hench_geth_ss_global_hench_geth_00315453_m.ogg
    track: voice
  legion_target_eliminated:
    file: en_us_hench_geth_ss_global_hench_geth_00315458_m.ogg
    track: voice
  legion_enemy_disabled:
    file: en_us_hench_geth_ss_global_hench_geth_00315466_m.ogg
    track: voice
  # Sounds for banks
  legion_target_positive_y:
    file: en_us_hench_geth_ss_global_hench_geth_00242507_m.ogg
    track: voice
  legion_target_negative_x:
    file: en_us_hench_geth_ss_global_hench_geth_00242508_m.ogg
    track: voice
  legion_target_positive_x:
    file: en_us_hench_geth_ss_global_hench_geth_00242509_m.ogg
    track: voice
  legion_target_negative_y:
    file: en_us_hench_geth_ss_global_hench_geth_00242510_m.ogg
    track: voice

# widget_player:
#   timer_heretic_timer_tick:
#     secondary_timer_widget:
#       action: update
#       slide: recruit_mission_slide
#   timer_heretic_timer_complete:
#     secondary_timer_widget:
#       action: remove
#   timer_heretic_timer_stopped:
#     secondary_timer_widget:
#       action: remove

widget_player:
  slide_recruit_mission_slide_created:
    heretic_hack_progress_widget:
      action: add
      slide: recruit_mission_slide

widgets:
  heretic_hack_progress_widget:
    - type: text
      text: "Hack: (player|heretic_progress) / 60"
      style: header_xs, row_gutter, col_left_center
