#config_version=5

#####
# LEGION RECRUIT MISSION
#
# This mode requires a sequence of shots to be hit: either orbit, either ramp,
# and then either orbit. When one shot is hit a 10s timer begins for the next one,
# and if the timer expires the shot is disabled and one of the hit/drop banks is
# lit. The player must hit the lit dropbank to re-enable the sequence shot.
#
# When the sequence is complete, the mission is "successful" and the player
# recruits Legion immediately. The kickback shot will light for a multiplier,
# a paragon/renegade bonus award, and a levelup. If the timer expires before the
# shot is hit then no bonus/levelup is awarded, but Legion is recruited and the
# mission is no longer available.
#
# Progress is saved for the sequence during an attempt, but the sequence resets
# each time the mode begins.
#
# TOOD: If the timer is <10s when the sequence advances, it is bumped up to 10s
# (except for the bonus shot).
#####

mode:
  start_events: start_mode_recruitlegion
  stop_events: stop_mode_recruitlegion, stop_recruitmission, stop_missions
  # We use the banks as a shot target, so disable the drops and lock hits
  events_when_started: mode_type_mission_started, disable_sbdrops_counter, disable_lock_lightshot
  events_when_stopped: mode_type_mission_stopped, enable_sbdrops_counter, enable_lock_lightshot
  priority: 500

event_player:
  mode_recruitlegion_started.1:
    set_environment:
      env: geth
  mode_recruitlegion_started.2:
    - play_opening_heretic_dialogue
  timer_heretic_timer_complete:
    - enable_random_heretic
  heretic_kickback_shot_hit:
    - recruit_legion_complete
  enable_heretic_shot_dropbank:
    - squad_target_left
    - reset_dropbank
  enable_heretic_shot_hitbank:
    - squad_target_right
  # Set legion recruited but only "success" on kickback
  logicblock_heretic_counter_complete:
    - recruit_legion_precomplete
    # It's mean to enable the bonus shot with only a few seconds to spare :(
    - recruittimer_set_twelve{device.timers.recruittimer.ticks<12}
  heretic_shot_bonus_hit: recruit_legion_complete

random_event_player:
  enable_random_heretic:
    events:
      - enable_heretic_shot_dropbank
      - enable_heretic_shot_hitbank

counters:
  heretic_counter:
    starting_count: 0
    count_complete_value: 3
    count_events: heretic_sequence_shots_lit_hit
    reset_events: mode_recruitlegion_started

timers:
  heretic_timer:
    start_value: 10
    end_value: 0
    direction: down
    start_running: false
    control_events:
      - event: heretic_sequence_shots_lit_hit
        action: restart
      - event: logicblock_heretic_counter_complete
        action: stop

#####
# LEGION SCORING
#   The hurryup starts at 600 and ticks down 10/s
#   The build value starts at 1000
#   Hitting a lit shot awards the hurryup immediately and
#   adds a build value of hurryup times 10x num. of shots hit
#   Completing the mode awards the built value
#####
variable_player:
  mode_recruitlegion_started:
    temp_multiplier:
      action: set
      int: 1
    temp_build_value:
      action: set
      int: 1000
    temp_hurryup_value:
      action: set
      int: 600
  logicblock_heretic_counter_hit:
    temp_multiplier: 1
  timer_recruittimer_tick:
    temp_hurryup_value: -10
  heretic_shots_lit_hit:
    temp_build_value: current_player.temp_multiplier * temp_hurryup_value * 10
    score: current_player.temp_hurryup_value
  heretic_kickback_shot_hit:
    score: current_player.temp_build_value

shot_groups:
  heretic_sequence_shots:
    shots: heretic_shot_orbits, heretic_shot_ramps
    restart_events: mode_recruitlegion_started
    enable_events: heretic_recovery_shots_hit
    disable_events: enable_random_heretic, logicblock_heretic_counter_complete
    rotate_events: heretic_sequence_shots_lit_hit
  heretic_recovery_shots:
    shots: heretic_shot_dropbank, heretic_shot_hitbank
    disable_events: mode_recruitlegion_started, heretic_recovery_shots_hit

shots:
  heretic_shot_bonus:
    hit_events: sh_kickback_hit
    enable_events: logicblock_heretic_counter_complete
    profile: color_flashing_fast_profile
    show_tokens:
      leds: l_kickback_shield_rgb
      color: FFFFFF #color_legion
    tags: envshot_kickback
  # Dropbank and hitbank are "recovery" shots
  heretic_shot_dropbank:
    hit_events: sh_dropbank_top_hit, sh_dropbank_middle_hit, sh_dropbank_bottom_hit
    enable_events: enable_heretic_shot_dropbank
    disable_events: mode_recruitlegion_started, heretic_recovery_shots_hit
    profile: color_flashing_fast_static
    show_tokens:
      leds: l_dropbank_shield_rgb
      color: FFFFFF #color_legion
    tags: envshot_dropbank
  heretic_shot_hitbank:
    hit_events: sh_hitbank_top_hit, sh_hitbank_bottom_hit
    enable_events: enable_heretic_shot_hitbank
    disable_events: mode_recruitlegion_started, heretic_recovery_shots_hit
    profile: color_flashing_fast_static
    show_tokens:
      leds: l_hitbank_shield_rgb
      color: FFFFFF #color_legion
    tags: envshot_hitbank
  # Orbits and ramps are "sequence" shots
  heretic_shot_orbits:
    hit_events: sh_left_orbit_hit, sh_right_orbit_hit
    advance_events: play_opening_heretic_dialogue
    profile: hit_to_flash_profile_noadvance
    show_tokens:
      leds: l_left_orbit_shield_rgb, l_right_orbit_shield_rgb
      color: FFFFFF #color_legion
    tags: envshot_left_orbit, envshot_right_orbit
  heretic_shot_ramps:
    hit_events: sh_left_ramp_hit, sh_right_ramp_hit
    profile: hit_to_flash_profile_noadvance
    show_tokens:
      leds: l_left_ramp_shield_rgb, l_right_ramp_shield_rgb
      color: FFFFFF #color_legion
    tags: envshot_left_ramp, envshot_right_ramp

sound_player:
  mode_recruitlegion_started:
    music_legion:
      action: play
      mode_end_action: stop
      volume: 1
  play_opening_heretic_dialogue: shepard_start_your_upload
  logicblock_heretic_counter_hit{count==1}: legion_alert_mobile_platforms
  logicblock_heretic_counter_hit{count==2}: legion_alert_close_combat
  player_shot_heretic_shot_dropbank_enabled{value==True}: squad_target_left
  player_shot_heretic_shot_hitbank_enabled{value==True}: squad_target_right
  recruit_legion_precomplete:
    legion_hack_complete:
      action: play
    music_legion_low:
      action: play
      mode_end_action: stop

sounds:
  music_legion:
    file: mus_legion_acq_combat_1.ogg
    track: music
    fade_in: 2s
    fade_out: 1s
  music_legion_low:
    file: mus_legion_acq_tension_1.ogg
    track: music
    fade_in: 1s
    fade_out: 1s
  shepard_start_your_upload:
    file: en_us_player_f_gthgtl_core_h_00183211_f.ogg
    track: voice
    volume: 0.8
  legion_alert_mobile_platforms:
    file: en_us_hench_geth_gthgtl_towerdef_h_00183217_m.ogg
    track: voice
    max_queue_time: 1s
    ducking:
      target: music
      attenuation: 0.5
      attack: 50ms
      release: 100ms
      release_point: 50ms
  legion_alert_close_combat:
    file: en_us_hench_geth_gthgtl_towerdef_h_00183218_m.ogg
    track: voice
    max_queue_time: 1s
    ducking:
      target: music
      attenuation: 0.5
      attack: 50ms
      release: 100ms
      release_point: 50ms
  legion_hack_complete:
    file: en_us_hench_geth_gthgtl_towerdef_h_00183219_m.ogg
    track: voice
    max_queue_time: 3s
    ducking:
      target: music
      attenuation: 0.5
      attack: 50ms
      release: 100ms
      release_point: 50ms

widget_player:
  timer_heretic_timer_tick:
    secondary_timer_widget:
      action: update
      slide: recruit_mission_slide
  timer_heretic_timer_complete:
    secondary_timer_widget:
      action: remove
  timer_heretic_timer_stopped:
    secondary_timer_widget:
      action: remove
