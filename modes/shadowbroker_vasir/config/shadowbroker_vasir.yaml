#config_version=5

#####
# LAIR OF THE SHADOW BROKER: VASIR COMBAT
#
# This mode begins immediately upon completion of the Chase mode and involves
# a fast-moving target that must be hit three times. The target is lit for Vasir's
# barriers (purple), then armor (yellow), then health (red), and rotates to a
# new shot every 12 seconds. Hitting the target three times defeats Vasir and
# completes the mode.
#
# This mode has a hurryup timer and the mode fails if the timer expires.
#
# TODO: Scoring
#
# Progress is saved upon completion of this mode, enabling the player to advance
# to the Hagalaz/Boss modes. If this mode is failed, it may only be restarted
# by completing the Chase mode again.
#####

mode:
  start_events: start_mode_shadowbroker_vasir
  stop_events: stop_mode_shadowbroker_vasir
  priority: 850

event_player:
  timer_vasir_timeout_complete: stop_mode_shadowbroker_vasir
  shadowbroker_vasir_complete: stop_mode_shadowbroker_vasir
  stop_mode_shadowbroker_vasir: exit_shadowbroker_modes
  # Need a better way than each shot at the health profile
  sbvasir_left_ramp_health_hit: shadowbroker_vasir_complete
  sbvasir_left_orbit_health_hit: shadowbroker_vasir_complete
  sbvasir_right_ramp_health_hit: shadowbroker_vasir_complete
  sbvasir_right_orbit_health_hit: shadowbroker_vasir_complete
  sbvasir_kickback_health_hit: shadowbroker_vasir_complete
  sbvasir_dropbank_health_hit: shadowbroker_vasir_complete
  sbvasir_hitbank_health_hit: shadowbroker_vasir_complete

shot_groups:
  vasir_shot:
    rotate_right_events: timer_vasir_timer_complete
    shots:
      - sbvasir_hitbank
      - sbvasir_left_orbit
      - sbvasir_right_ramp
      - sbvasir_dropbank
      - sbvasir_left_ramp
      - sbvasir_right_orbit

shot_profiles:
  sbvasir_shot_profile:
    loop: true
    states:
      - name: off
        show: off
        manual_advance: true
      - name: barrier
        show: vasir_barrier_show
        speed: 4
        show_tokens:
          color: purple
      - name: armor
        show: vasir_armor_show
        speed: 8
        show_tokens:
          color: yellow
      - name: health
        show: vasir_health_show
        speed: 12
        show_tokens:
          color: red

shots:
  sbvasir_left_ramp:
    hit_events: sh_left_ramp_hit
    profile: sbvasir_shot_profile
    show_tokens:
      leds: l_left_ramp_shield_rgb
  sbvasir_left_orbit:
    hit_events: sh_left_orbit_hit
    profile: sbvasir_shot_profile
    show_tokens:
      leds: l_left_orbit_shield_rgb
  sbvasir_right_ramp:
    hit_events: sh_right_ramp_hit
    profile: sbvasir_shot_profile
    show_tokens:
      leds: l_right_ramp_shield_rgb
  sbvasir_right_orbit:
    hit_events: sh_right_orbit_hit
    profile: sbvasir_shot_profile
    show_tokens:
      leds: l_right_orbit_shield_rgb
  sbvasir_kickback:
    hit_events: sh_kickback_hit
    profile: sbvasir_shot_profile
    show_tokens:
      leds: l_kickback_shield_rgb
  sbvasir_dropbank:
    hit_events: sh_dropbank_top_hit, sh_dropbank_middle_hit, sh_dropbank_bottom_hit
    profile: sbvasir_shot_profile
    show_tokens:
      leds: l_dropbank_shield_rgb
  sbvasir_hitbank:
    advance_events: mode_shadowbroker_vasir_started # Start with hitbank enabled
    hit_events: sh_hitbank_top_hit, sh_hitbank_bottom_hit
    profile: sbvasir_shot_profile
    show_tokens:
      leds: l_hitbank_shield_rgb

shows:
  vasir_barrier_show:
    - time: 0
      lights:
        (leds): purple
    - time: '+1'
      lights:
        (leds): black
  vasir_armor_show:
    - time: 0
      lights:
        (leds): yellow
    - time: '+1'
      lights:
        (leds): black
  vasir_health_show:
    - time: 0
      lights:
        (leds): red
    - time: '+1'
      lights:
        (leds): black

slide_player:
  mode_shadowbroker_vasir_started: sbvasir_slide

slides:
  sbvasir_slide:
    widgets:
      - type: text
        text: DEFEAT VASIR
        style: quadrit_big
        animations:
          show_slide:                # animation trigger event
            - property: opacity      # name of the widget property we're animating
              value: 1               # target value of that property for this step
              duration: .25s          # duration for this step (how long it takes to get there)
            - property: opacity      # second step in the animation (starts with a hyphen)
              value: 0.5
              duration: .25s
              repeat: true

timers:
  vasir_timer:  # Timer for the shot rotation
    start_value: 12
    end_value: 0
    tick_interval: 1s
    direction: down
    restart_on_complete: true
    start_running: true
    control_events:
      - event: mode_shadowbroker_vasir_will_stop
        action: stop
  vasir_timeout: # Timer for the mode to fail
    start_value: 120
    end_value: 0
    tick_interval: 1s
    direction: down
    start_running: true
    control_events:
      - event: shadowbroker_vasir_complete
        action: stop


widget_player:
  timer_vasir_timeout_started: timer_widget
  timer_vasir_timeout_tick:
    timer_widget:
      action: update
  stop_mode_shadowbroker_chase:
    timer_widget:
      action: remove

widgets:
  timer_widget:
    - type: text
      text: (ticks_remaining)
      style: dmd_small
      anchor_x: right
      anchor_y: top
      x: right-2
      y: top-2
