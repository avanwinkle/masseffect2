#config_version=5

#####
# SUICIDE MISSION: BASE MODE
#
# This is the mode handler for the Suicide Mission, responsible for starting and
# stopping the various sub-modes of the game finale.
#
#####

mode:
  start_events: start_mode_suicide_base
  stop_events: suicidemission_complete, suicidemission_failed, suicidemission_ended
  events_when_started: mode_type_wizard_started, enable_fullorbit, start_mode_harbinger
  events_when_stopped: mode_type_wizard_stopped, stop_mode_harbinger
  code: suicide_base.SuicideBase
  priority: 2000

event_player:
  mode_suicide_base_started.1:
    - start_mode_suicide_omegarelay{device.achievements.omegarelay.state!="completed"}
    - start_mode_missionselect{device.achievements.omegarelay.state=="completed" and (device.achievements.infiltration.state!="completed" or device.achievements.longwalk.state!="completed")}
    - start_mode_suicide_platforms{device.achievements.longwalk.state=="completed" and device.achievements.humanreaper.state!="completed"}
    - start_mode_suicide_endrun{device.achievements.humanreaper.state=="completed" and device.achievements.endrun.state!="completed"}
  # Wait for the mission selection of a specialist before starting infiltration or long walk
  missionselect_specialist_selected:
    - start_mode_suicide_infiltration{device.achievements.infiltration.state!="completed"}
    - start_mode_suicide_longwalk{device.achievements.infiltration.state=="completed"}
  # Progression
  omegarelay_complete: start_mode_missionselect
  achievement_infiltration_state_completed: start_mode_missionselect  # Use the achievement state because that's what mission select checks
  longwalk_complete: start_mode_suicide_platforms
  platforms_complete: start_mode_suicide_humanreaper
  # reaper goes back to platforms when it "fails"
  humanreaper_failed: start_mode_suicide_platforms
  humanreaper_complete: start_mode_suicide_endrun
  endrun_complete:
    - levelup
    - suicidemission_complete
  # Remember the score before starting the suicide mission, in case it fails
  mode_suicide_base_started.2{current_player.presuicide_score==0}:
    presuicide_score:
      action: set
      int: current_player.score
  # We don't end on ball_ending for the queue player, so trigger that here
  # TODO: move all the post-drain queue logic into the custom code and avoid the relay player?
  ball_ending{not mode.suicide.infltration.active and not mode.suicide_longwalk.active}: suicidemission_ended

queue_relay_player:
  # If the ball drains during infiltration or longwalk, kill the specialist too
  ball_ending{mode.suicide_infiltration.active or mode.suicide_longwalk.active}:
    post: kill_squadmate
    args:
      squadmate: specialist
    wait_for: squadmate_killed_complete # TODO: change this to a post-sound-effect event

ball_saves:
  omegarelay_save:
    enable_events: multiball_omegarelay_ended
    only_last_ball: true
    delayed_eject_events: mode_suicide_infiltration_started
    auto_launch: true # Must be true because we have a multiball starting too

variable_player:
  # Track whether we are progressing into a mode or starting a new ball
  mode_suicide_base_started:
    suicide_continuing:
      action: set
      int: 0
    # Human Reaper hit points... 100,000?
    reaper_hp:
      action: set
      int: 100000
    reaper_rounds:
      action: set
      int: 6
  kill_specialist:
    suicide_continuing:
      action: set
      int: 0
  omegarelay_complete:
    suicide_continuing: 1
  infiltration_complete:
    suicide_continuing: 1
  longwalk_complete:
    suicide_continuing: 1
  humanreaper_complete:
    suicide_continuing: 1
  mode_suicide_humanreaper_started{current_player.reaper_rounds>0}:
    reaper_rounds: -1

sound_player:
  # This is a hacky way to get MCP to listen to 'play_squadmate_sound' events :/
  # play_squadmate_sound: squadmate_thane_killed_inf
  squadmate_killed{not ball_is_ending}: suicide_music_base
  mode_type_suicide_started:
    suicide_music_base:
      action: stop
      fade_out: 2s
  mode_suicide_base_will_stop:
    suicide_music_base:
      action: stop
      fade_out: 2s
  # Play the final valve sound here so we can stop the infiltration mode immediately
  infiltration_complete: specialist_inf_through
  # Handle the transition between platform/reaper phases for seamlessness
  # Start by playing the intro track when the long walk is completed
  longwalk_complete: suicide_music_intro
  # Seamlessly blend that one into the 3a
  start_mode_suicide_platforms:
    suicide_music_3a:
      start_at: 0s
  # When it's reaper time, switch to reaper music
  start_mode_suicide_humanreaper:
    suicide_music_platforms:
      action: stop
    suicide_music_reaper:
      action: play
  # When we move from reaper back to platforms, skip the intro
  humanreaper_failed:
    suicide_music_reaper:
      action: stop
    suicide_music_platforms:
      action: play

sound_pools:
  suicide_music_platforms:
    type: sequence
    track: music
    sounds: suicide_music_3b, suicide_music_3a
    fade_out: 2s
  specialist_inf_through:
    track: voice
    sounds:
      - specialist_garrus_im_through_opening_doors_now{current_player.specialist=="garrus"}
      - specialist_jacob_im_through_opening_doors_now{current_player.specialist=="jacob"}
      - specialist_legion_im_through_opening_doors_now{current_player.specialist=="legion"}
      - specialist_kasumi_im_through_opening_doors_now{current_player.specialist=="kasumi"}
      - specialist_mordin_im_through_opening_doors_now{current_player.specialist=="mordin"}
      - specialist_tali_im_through_opening_doors_now{current_player.specialist=="tali"}
      - specialist_thane_im_through_opening_doors_now{current_player.specialist=="thane"}


sounds:
  suicide_music_base:
    file: mus_endgm1_attackplan.ogg
    track: music
  suicide_music_intro:
    file: mus_endgm2_speech_conv_b.ogg
    track: music
    markers:
      - time: 37s
        events: play_suicide_music_platforms
  suicide_music_3a:
    file: mus_endgm2_combat_3a.ogg
    track: music
    start_at: 3s
    fade_in: 500ms
  suicide_music_3b:
    file: mus_endgm2_combat_3b.ogg
    track: music
    start_at: 7s
    fade_in: 2s
  suicide_music_reaper:
    file: mus_endgm2_reaperdeath.ogg
    track: music
    fade_out: 1s
  # Death
  squadmate_thane_killed_inf:
    file: en_us_hench_assassin_endgm2_gutterrunner_a_00245891_m.ogg
    track: voice
  squadmate_garrus_killed_inf:
    file: en_us_hench_garrus_endgm2_gutterrunner_a_00245890_m.ogg
    track: voice
  squadmate_legion_killed_inf:
    file: en_us_hench_geth_endgm2_gutterrunner_a_00245888_m.ogg
    track: voice
  squadmate_jacob_killed_inf:
    file: en_us_hench_leading_endgm2_gutterrunner_a_00245886_m.ogg
    track: voice
  squadmate_mordin_killed_inf:
    file: en_us_hench_professor_endgm2_gutterrunner_a_00245893_m.ogg
    track: voice
  squadmate_tali_killed_inf:
    file: en_us_hench_tali_endgm2_gutterrunner_a_00245892_m.ogg
    track: voice
  squadmate_kasumi_killed_inf:
    file: en_us_hench_thief_endgm2_gutterrunner_a_00245889_m.ogg
    track: voice
  # Killed Callback
  squadmate_jacob_killed_callback_shepard_inf:
    file: en_us_player_f_endgm2_tech_culmination_c_00282111_f.ogg
    track: voice
  squadmate_legion_killed_callback_shepard_inf:
    file: en_us_player_f_endgm2_tech_culmination_c_00282112_f.ogg
    track: voice
  squadmate_kasumi_killed_callback_shepard_inf:
    file: en_us_player_f_endgm2_tech_culmination_c_00282113_f.ogg
    track: voice
  squadmate_garrus_killed_callback_shepard_inf:
    file: en_us_player_f_endgm2_tech_culmination_c_00282114_f.ogg
    track: voice
  squadmate_thane_killed_callback_shepard_inf:
    file: en_us_player_f_endgm2_tech_culmination_c_00282115_f.ogg
    track: voice
  squadmate_tali_killed_callback_shepard_inf:
    file: en_us_player_f_endgm2_tech_culmination_c_00282116_f.ogg
    track: voice
  squadmate_mordin_killed_callback_shepard_inf:
    file: en_us_player_f_endgm2_tech_culmination_c_00282117_f.ogg
    track: voice
  squadmate_jacob_killed_callback_shepard_lw:
    file: en_us_player_f_endgm2_biotic_fail_c_00266790_f.ogg
    track: voice
  squadmate_samara_killed_callback_shepard_lw:
    file: en_us_player_f_endgm2_biotic_fail_c_00266791_f.ogg
    track: voice
  squadmate_grunt_killed_callback_shepard_lw:
    file: en_us_player_f_endgm2_biotic_fail_c_00266792_f.ogg
    track: voice
  squadmate_garrus_killed_callback_shepard_lw:
    file: en_us_player_f_endgm2_biotic_fail_c_00266793_f.ogg
    track: voice
  squadmate_tali_killed_callback_shepard_lw:
    file: en_us_player_f_endgm2_biotic_fail_c_00266794_f.ogg
    track: voice
  squadmate_legion_killed_callback_shepard_lw:
    file: en_us_player_f_endgm2_biotic_fail_c_00266795_f.ogg
    track: voice
  squadmate_jack_killed_callback_shepard_lw:
    file: en_us_player_f_endgm2_biotic_fail_c_00266796_f.ogg
    track: voice
  squadmate_zaeed_killed_callback_shepard_lw:
    file: en_us_player_f_endgm2_biotic_fail_c_00266797_f.ogg
    track: voice
  squadmate_mordin_killed_callback_shepard_lw:
    file: en_us_player_f_endgm2_biotic_fail_c_00266798_f.ogg
    track: voice
  squadmate_kasumi_killed_callback_shepard_lw:
    file: en_us_player_f_endgm2_biotic_fail_c_00266799_f.ogg
    track: voice
  squadmate_thane_killed_callback_shepard_lw:
    file: en_us_player_f_endgm2_biotic_fail_c_00266800_f.ogg
    track: voice
  squadmate_miranda_killed_callback_shepard_lw:
    file: en_us_player_f_endgm2_biotic_fail_c_00266801_f.ogg
    track: voice
  # Infiltration specialist complete
  specialist_thane_im_through_opening_doors_now:
    file: en_us_hench_assassin_endgm2_gutterrunner_a_00258899_m.ogg
    track: voice
  specialist_garrus_im_through_opening_doors_now:
      file: en_us_hench_garrus_endgm2_gutterrunner_a_00258898_m.ogg
      track: voice
  specialist_legion_im_through_opening_doors_now:
      file: en_us_hench_geth_endgm2_gutterrunner_a_00258896_m.ogg
      track: voice
  specialist_jacob_im_through_opening_doors_now:
      file: en_us_hench_leading_endgm2_gutterrunner_a_00258895_m.ogg
      track: voice
  specialist_mordin_im_through_opening_doors_now:
      file: en_us_hench_professor_endgm2_gutterrunner_a_00258901_m.ogg
      track: voice
  specialist_tali_im_through_opening_doors_now:
      file: en_us_hench_tali_endgm2_gutterrunner_a_00258900_m.ogg
      track: voice
  specialist_kasumi_im_through_opening_doors_now:
      file: en_us_hench_thief_endgm2_gutterrunner_a_00258897_m.ogg
      track: voice


show_player:
  # Light the missions arrow to select a specialist after one died
  squadmate_killed{not ball_is_ending}:
    missions_available_show:
      action: play
  mode_missionselect_started:
    missions_available_show:
      action: stop
  mode_suicide_base_will_stop:
    missions_available_show:
      action: stop

slide_player:
  mode_type_suicide_started: suicide_slide
  mode_type_suicide_stopped:
    suicide_slide:
      action: remove
  squadmate_killed{not ball_is_ending}: specialist_killed_slide
  missionselect_specialist_selected:
    specialist_killed_slide:
      action: remove
  suicidemission_ended:
    specialist_killed_slide:
      action: remove

slides:
  suicide_slide:
    widgets:
      - type: text
        text: the Suicide Mission
        color: BBBBBB
        style: small
        anchor_y: top
        y: top-2
  specialist_killed_slide:
    widgets:
      - type: text
        text: Shoot ramp to try again
        style: small
        anchor_y: top
        y: middle-4

widget_player:
  mode_suicide_omegarelay_started:
    omegarelay_title:
      slide: suicide_slide
    suicide_time:
      slide: suicide_slide
  mode_suicide_infiltration_started:
    omegarelay_title:
      action: remove
    infiltration_title:
      slide: suicide_slide
  mode_suicide_longwalk_started:
    infiltration_title:
      action: remove
    longwalk_title:
      slide: suicide_slide
  mode_suicide_platforms_started:
    longwalk_title:
      action: remove
    humanreaper_title:
      action: remove
    platforms_title:
      slide: suicide_slide
  mode_suicide_humanreaper_started:
    platforms_title:
      action: remove
    humanreaper_title:
      slide: suicide_slide
  mode_suicide_endrun_started:
    humanreaper_title:
      action: remove
    endrun_title:
      slide: suicide_slide
  timer_omegarelay_tick:
    suicide_time:
      action: update
  timer_infiltration_tick:
    suicide_time:
      action: update
  timer_longwalk_tick:
    suicide_time:
      action: update
  logicblock_swarmpaths_hit:
    suicide_shots:
      action: update
  logicblock_valves_hit:
    suicide_shots:
      action: update
  squadmate_killed:
    specialist_killed_widget:
      action: update
      slide: specialist_killed_slide

widgets:
  omegarelay_title:
    - type: text
      text: Omega 4 Relay
      style: text_default
  infiltration_title:
    - type: text
      text: Infiltration
      style: text_default
  longwalk_title:
    - type: text
      text: the Long Walk
      style: text_default
  platforms_title:
    - type: text
      text: Final Battle
      style: text_default
  humanreaper_title:
    - type: text
      text: the Human Reaper
      style: text_default
  endrun_title:
    - type: text
      text: the End Run
      style: text_default
  suicide_time:
    - type: text
      text: (ticks)
      style: small
      anchor_x: left
      anchor_y: bottom
      x: 2
      y: 2
  suicide_shots:
    - type: text
      text: "Shots: (count)"
      style: small
      anchor_x: right
      anchor_y: bottom
      x: right-2
      y: 2
  specialist_killed_widget:
    - type: text
      text: (squadmate) is dead
      style: small
      anchor_y: bottom
      y: middle+4
