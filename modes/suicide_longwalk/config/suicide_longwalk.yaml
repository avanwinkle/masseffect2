#config_version=5

#####
# SUICIDE MISSION Pt. III: THE LONG WALK
#
# This mode begins with the player selecting a biotic specialist from the
# recruited squadmates (excluding any that died during the Infiltration mode).
# The player must then hit a series of randomly-placed shots to make their way
# through the central chamber, staying close to the biotic's protective barrier.
#
# This mode is on a timer, which resets every time a path shot is hit. An incorrect
# shot (i.e. any lane that's not lit) drops the timer down to the nearest 1/3rd.
# If the timer runs out a random squadmate is pulled from the protective
# barrier and killed, and the player must re-start the mode by hitting the left-
# lane lock.
#
# If the ball drains during this mode, the biotic specialist is killed
# and the player must select a new one at the beginning of their next ball. If
# all biotic specialists die, the Suicide Mission fails and the player is
# returned to the recruitment mode to recruit more squadmates.
######

mode:
  start_events: start_mode_suicide_longwalk
  stop_events: longwalk_complete, longwalk_failed
  events_when_started: mode_type_suicide_started, reset_tension
  events_when_stopped: mode_type_suicide_stopped
  code: suicide_longwalk.LongWalk
  priority: 2300

event_player:
  mode_suicide_longwalk_started:
    set_environment:
      env: collectors
    set_initial_suicide_shots:
      count: 7
  player_tension{change>0}: increase_tension
  enable_longwalk_dropbank: reset_dropbank
  logicblock_swarmpaths_hit:
    - reset_tension
    - play_specialist_lw_advance{count>1}
    - play_specialist_lw_close{count==1}
  player_tension{value==1}:
    - play_specialist_lw_warning_barrier{device.counters.barrier_warning.value==0}
    - play_specialist_lw_warning_med{device.counters.barrier_warning.value>0}
  reset_tension:
    set_initial_suicide_ticks:
      ticks: 60
  timer_longwalk_complete:
    kill_squadmate:
      squadmate: random
  squadmate_killed: longwalk_failed
  logicblock_swarmpaths_complete: longwalk_complete

counters:
  barrier_warning:
    starting_count: 0
    count_events: increase_tension
    reset_events: mode_suicide_longwalk_started
  swarmpaths:
    starting_count: 7
    count_complete_value: 0
    direction: down
    count_events: swarmpaths_hit
    persist_state: true
    reset_events: mode_suicide_longwalk_started

timers:
  longwalk:
    start_value: 60
    end_value: 0
    tick_interval: 1s
    direction: down
    start_running: true
    control_events:
      - event: reset_tension
        action: restart
      - event: logicblock_swarmpaths_complete
        action: stop
      - event: player_tension{value==1 and current_player.suicide_longwalk_longwalk_tick>41}
        action: jump
        value: 41
      - event: player_tension{value==2 and current_player.suicide_longwalk_longwalk_tick>21}
        action: jump
        value: 21
      - event: player_tension{value==3 and current_player.suicide_longwalk_longwalk_tick>0}
        action: jump
        value: 0

variable_player:
  mode_suicide_longwalk_started:
    tension:
      action: set
      int: 0
  timer_longwalk_tick{ticks==41 or ticks==21}:
    tension: 1
  swarmfails_hit:
    tension: 1
  reset_tension:
    tension:
      action: set
      int: 0
  # Clear the tension value so we don't duplicate the music when the reset jumps it to zero
  longwalk_failed:
    tension:
      action: set
      int: -1

shot_groups:
  swarmpaths:
    shots: longwalk_dropbank, longwalk_left_orbit, longwalk_kickback, longwalk_left_ramp, longwalk_right_ramp, longwalk_right_orbit, longwalk_hitbank

shots:
  swarmfails:
    hit_events: envshot_left_orbit_nofull_hit, envshot_kickback_hit, envshot_left_ramp_hit, envshot_right_ramp_hit, envshot_right_orbit_nofull_hit
  longwalk_left_ramp:
    hit_events: sh_left_ramp_hit
    enable_events: enable_longwalk_left_ramp
    disable_events: mode_suicide_longwalk_will_stop, logicblock_swarmpaths_hit
    advance_events: increase_tension
    reset_events: reset_tension
    profile: longwalk_profile
    show_tokens:
      leds: l_left_ramp_shield_rgb
    tags: envshot_left_ramp
  longwalk_left_orbit:
    hit_events: sh_left_orbit_hit
    enable_events: enable_longwalk_left_orbit
    disable_events: mode_suicide_longwalk_will_stop, logicblock_swarmpaths_hit
    advance_events: increase_tension
    reset_events: reset_tension
    profile: longwalk_profile
    show_tokens:
      leds: l_left_orbit_shield_rgb
    tags: envshot_left_orbit_nofull
  longwalk_right_ramp:
    hit_events: sh_right_ramp_hit
    enable_events: enable_longwalk_right_ramp
    disable_events: mode_suicide_longwalk_will_stop, logicblock_swarmpaths_hit
    advance_events: increase_tension
    reset_events: reset_tension
    profile: longwalk_profile
    show_tokens:
      leds: l_right_ramp_shield_rgb
    tags: envshot_right_ramp
  longwalk_right_orbit:
    hit_events: sh_right_orbit_hit
    enable_events: enable_longwalk_right_orbit
    disable_events: mode_suicide_longwalk_will_stop, logicblock_swarmpaths_hit
    advance_events: increase_tension
    reset_events: reset_tension
    profile: longwalk_profile
    show_tokens:
      leds: l_right_orbit_shield_rgb
    tags: envshot_right_orbit_nofull
  longwalk_kickback:
    hit_events: sh_kickback_hit
    enable_events: enable_longwalk_kickback
    disable_events: mode_suicide_longwalk_will_stop, logicblock_swarmpaths_hit
    advance_events: increase_tension
    reset_events: reset_tension
    profile: longwalk_profile
    show_tokens:
      leds: l_kickback_shield_rgb
    tags: envshot_kickback
  longwalk_dropbank:
    hit_events: sh_dropbank_top_hit, sh_dropbank_middle_hit, sh_dropbank_bottom_hit
    enable_events: enable_longwalk_dropbank
    disable_events: mode_suicide_longwalk_will_stop, logicblock_swarmpaths_hit
    advance_events: increase_tension
    reset_events: reset_tension
    profile: longwalk_profile
    show_tokens:
      leds: l_dropbank_shield_rgb
    tags: envshot_dropbank
  longwalk_hitbank:
    hit_events: sh_hitbank_top_hit, sh_hitbank_bottom_hit
    enable_events: enable_longwalk_hitbank
    disable_events: mode_suicide_longwalk_will_stop, logicblock_swarmpaths_hit
    advance_events: increase_tension
    reset_events: reset_tension
    profile: longwalk_profile
    show_tokens:
      leds: l_hitbank_shield_rgb
    tags: envshot_hitbank

shot_profiles:
  longwalk_profile:
    states:
      - name: low
        show: swarmpath_show
        speed: 1
        show_tokens:
          fadetime: 0
      - name: med
        show: swarmpath_show
        speed: 2
        show_tokens:
          fadetime: 0
      - name: high
        show: swarmpath_show
        speed: 3
        show_tokens:
          fadetime: 0

show_player:
  swarmfails_hit:
    swarmpath_show:
      action: play
      loops: 1

shows:
  swarmpath_show:
    - time: 0
      lights:
        (leds):
          color: 0066ff #color_paragon
          fade: (fadetime)
    - time: '+1'
      lights:
        (leds):
          color: off
          fade: (fadetime)
  swarmfail_show:
    - time: 0
      flashers:
        l_flash_dragon_left: 150ms
        l_flash_back_panel_left: 150ms

light_player:
  mode_suicide_longwalk_started:
    l_gi_left_playfield:
      color: off
      fade: 1s
    l_gi_lower_playfield:
      color: off
      fade: 1s
    l_gi_upper:
      color: 333333
      fade: 1s

sound_player:
  player_tension{value==1}:
    longwalk_low:
      action: stop
    longwalk_med:
      action: play
      start_at: 18s
  player_tension{value==2}:
    longwalk_med:
      action: stop
    longwalk_high:
      action: play
      start_at: 34s
    specialist_lw_warning_high:
      action: play
  # If we were already low-tension, no need to restart the music
  player_tension{value==0 and change<0}:
    longwalk_low:
      action: play
      start_at: 10s
    longwalk_med:
      action: stop
    longwalk_high:
      action: stop
    specialist_lw_warning_med:
      action: stop
    specialist_lw_warning_high:
      action: stop
  # We play the "leaving the barrier" sound for the first increase
  play_specialist_lw_warning_barrier: specialist_lw_warning_barrier
  play_specialist_lw_warning_med: specialist_lw_warning_med
  play_specialist_lw_advance: specialist_lw_advance
  play_specialist_lw_close: specialist_lw_close
  squadmate_killed{squadmate==current_player.specialist}:
    specialist_death_lw:
      action: play
      events_when_played: squadmate_killed_complete
  squadmate_killed{squadmate!=current_player.specialist}:
    random_death_lw:
      action: play
      priority: 100
      events_when_stopped: squadmate_killed_callback
    random_death_callback_lw:
      action: play
      priority: 1
      events_when_played: squadmate_killed_complete
    specialist_lw_warning_med:
      action: stop
    specialist_lw_warning_high:
      action: stop
    specialist_lw_advance:
      action: stop
    specialist_lw_close:
      action: stop
  # We start the music in huddle so make sure we end it on mode end
  mode_suicide_longwalk_will_stop:
    longwalk_low:
      action: stop
